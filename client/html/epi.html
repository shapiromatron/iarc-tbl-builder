<template name="epiMain">
  {{#if Template.subscriptionsReady}}
    {{#contentContainer}}
      {{> epiDescriptiveTbl}}
    {{/contentContainer}}
  {{else}}
    {{> isLoading}}
  {{/if }}
</template>


<template name="epiDescriptiveTblOpts">
    {{#actionBtn}}
        {{#if userCanEdit}}
            {{#unless showNew}}
                {{> optCreate }}
            {{/unless}}
            {{> optReorder }}
        {{/if}}
        {{> optMonoRefList}}
        {{> optFullScreen}}
        {{> optExcel }}
        {{> optWord }}
        {{> optRiskPlot}}
        {{> optShowAllRows}}
        {{> optQaFlags}}
        <li>
            <a href="{{pathFor 'epiAnalysisMain' _id=this._id}}">
                <span class="fa fa-table"></span> Data exploration
            </a>
        </li>
    {{/actionBtn}}
</template>


<template name="epiDescriptiveTbl">
  <h1>{{name}} {{>epiDescriptiveTblOpts}}</h1>
  {{> tableTitle}}

  <table class="evidenceTable table table-compressed">
    <colgroup>
      <col width="15%">
      <col width="15%">
      <col width="10%">
      <col width="11%">
      <col width="06%">
      <col width="12%">
      <col width="10%">
      <col width="21%">
    </colgroup>
    <thead>
      <tr>
        <th>Reference, location, follow-up/enrollment period, study-design</th>
        <th>Population size, description, exposure assessment method</th>
        <th>Organ site<br>(ICD code)</th>
        <th>Exposure category<br> or level</th>
        <th>Exposed<br>cases/<br>deaths</th>
        <th class="riskTR">Risk estimate<br>(95% CI)</th>
        <th>Covariates controlled</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody id="sortable">
      {{#each object_list}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
              data-id="{{_id}}"
              data-sortIdx="{{sortIdx}}">
            {{#if isEditing}}
              <td id="editingRow" colspan="100">
                {{> epiDescriptiveForm this isNew=false}}
              </td>
            {{else}}
              {{> epiDescriptiveRow}}
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No data has been entered into this table.</td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{> showNewBtn }}

  {{#if showNew}}
    {{> epiDescriptiveForm isNew=true}}
  {{/if}}
</template>


<template name='epiDescriptiveRow'>
  <td>
    {{#if userCanEdit}}
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
          <span class="caret" title="Editing options"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#"
               class="add-nested"
               title="Display modal for entering results">
              <span class="fa fa-medkit"></span> Add results</a></li>
          <li>
            <a href="#" id="clone-content">
              <span class="fa fa-copy"></span> Create a clone</a></li>
          <li>
            <a href="#" id="move-content">
              <span class="fa fa-arrow-circle-right"></span> Move to a different table</a></li>
          <li>
              <a href="#" id="toggle-hidden">{{#if isHidden}}
                <span class="glyphicon glyphicon-plus"></span> Show row
                {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{qaMark isQA}}
    {{>printReference id=referenceID}}<br>
    {{location}}<br>
    {{enrollmentDates}}<br>
    {{studyDesign}}
  </td>
  <td>{{{getCol2}}}</td>
  <td colspan="5" id="sortableInner">
    {{#each getChildren}}
      {{> epiResultTbl}}
    {{else}}
      <p class="help-block">No results have been created.
        {{#if userCanEdit}}
          <a href="#"
             class="btn btn-primary btn-sm add-nested pull-right"
             title="Display modal for entering results">
            <span class="fa fa-medkit"></span> Add results</a>
        {{/if}}
      </p>
    {{/each }}
  </td>
  <td>{{#if notes}}{{notes}}<br>{{/if}}
    <strong>Strengths: </strong>{{strengths}}<br>
    <strong>Limitations: </strong>{{limitations}}</td>
  <td class="dragHandle dhOuter" style="display: none" title="Drag to re-order rows"></td>
</template>


<template name="epiDescriptiveForm">
  <form id="mainForm" role="form" class="editForm">
    <legend>Epidemiological study description {{>formLegendPulldown}}</legend>
    <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.</p>

    <!-- First row -->
    <div class="form-group row">
      <div class="col-xs-3">
        {{> referenceSingleSelect}}
      </div>
      <div class="col-xs-3">
        {{> fldSelectSingle name="studyDesign" value=studyDesign }}
      </div>
      <div class="col-xs-3">
        {{> fldInputText name="location" value=location }}
      </div>
      <div class="col-xs-3">
        {{> fldInputText name="enrollmentDates" value=enrollmentDates }}
      </div>
    </div>

    <!-- Case-control row -->
    <div class="form-group row isCCinput">
      <div class="col-xs-12">
        <!-- Header labels -->
        <div class="row">
          <div class="col-xs-1">
          </div>
          <div class="col-xs-2">
            {{>fldLabel name="populationSizeCase"}}
          </div>
          <div class="col-xs-2">
            {{>fldLabel name="responseRateCase"}}
          </div>
          <div class="col-xs-4">
            {{>fldLabel name="sourceCase"}}
          </div>
          <div class="col-xs-3">
            {{> fldLabel name="eligibilityCriteria"}}
          </div>
        </div>

        <!-- Case-control inputs -->
        <div class="row">
          <div class="col-xs-1">
            <strong>Cases</strong><br><br><br>
            <strong>Controls</strong>
          </div>
          <div class="col-xs-2">
            {{> fldInputText name="populationSizeCase" value=populationSizeCase hideLabel=true }}
            <br>
            {{> fldInputText name="populationSizeControl" value=populationSizeControl hideLabel=true }}
          </div>
          <div class="col-xs-2">
            {{> fldInputText name="responseRateCase" value=responseRateCase hideLabel=true }}
            <br>
            {{> fldInputText name="responseRateControl" value=responseRateControl hideLabel=true }}
          </div>
          <div class="col-xs-4">
            {{> fldTextArea name="sourceCase" value=sourceCase hideLabel=true }}
            {{> fldTextArea name="sourceControl" value=sourceControl hideLabel=true }}
          </div>
          <div class="col-xs-3">
            {{> fldTextArea name="eligibilityCriteria" value=eligibilityCriteria hideLabel=true }}
          </div>
        </div>
      </div>
    </div>

    <!-- Cohort row #1-->
    <div class="form-group row isNotCCinput">
      <div class="col-xs-4">
        {{> fldTextArea name="eligibilityCriteria" value=eligibilityCriteria }}
      </div>
      <div class="col-xs-4">
        {{> fldTextArea name="populationDescription" value=populationDescription }}
      </div>
      <div class="col-xs-4">
        {{> fldTextArea name="outcomeDataSource" value=outcomeDataSource }}
      </div>
    </div>

    <!-- Cohort row #2-->
    <div class="form-group row isNotCCinput">
      <div class="col-xs-12">
        <div class="row">
          <div class="col-xs-4">
            {{> fldInputText name="populationSize" value=populationSize }}
          </div>
          <div class="col-xs-4">
            {{> fldInputText name="lossToFollowUp" value=lossToFollowUp }}
          </div>
          <div class="col-xs-4">
            {{> fldInputText name="referentGroup" value=referentGroup }}
          </div>
        </div>
      </div>
    </div>

    <!-- Fourth row -->
    <div class="form-group row">
      <div class="col-xs-4">
        {{> fldSelectSingle name="exposureAssessmentType" value=exposureAssessmentType }}
        {{> fldInputText name="exposureLevel" value=exposureLevel }}
      </div>
      <div class="col-xs-4">
        {{> fldTextArea name="exposureAssessmentNotes" value=exposureAssessmentNotes }}
      </div>
      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Possible co-exposures which may potentially confound results.">
                Possible co-exposures</label>
        {{> typeaheadSelectList name="coexposures" values=coexposures methodName="searchCoexposures"}}
      </div>
    </div>

    <!-- Fifth row -->
    <div class="form-group row">
      <div class="col-xs-4">
        {{> fldTextArea name="strengths" value=strengths }}
      </div>
      <div class="col-xs-4">
        {{> fldTextArea name="limitations" value=limitations }}
      </div>
      <div class="col-xs-4">
        {{> fldTextArea name="notes" value=notes }}
      </div>
    </div>

    <div id="errors"></div>
    {{> qaNotice}}
    {{> evidenceFormSubmissionDiv }}
  </form>
  <!-- Add input form-modals outside form scope -->
  {{> referenceQuickAddModal}}
  <div id="epiResultDiv"></div>
</template>


<template name="epiResultTbl">
  {{#if showRow isHidden}}
    <div class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
        data-id="{{_id}}"
        data-sortIdx="{{sortIdx}}">
      <table class="table table-condensed nestedTbl">
        <colgroup>
          <col width="20.4%">
          <col width="22.4%">
          <col width="12.2%">
          <col width="24.5%">
          <col width="20.5%">
        </colgroup>
        <tbody>
          {{#if displayEffectUnits . }}
            <tr>
              {{> organSiteTd }}
              <td colspan="4">{{effectUnits}}</td>
            </tr>
          {{/if}}
          {{#each eachIndex riskEstimates}}
            <tr>
              {{#if isEqual current=index target=0 }}
                {{#unless displayEffectUnits ..}}
                  {{> organSiteTd .. }}
                {{/unless}}
              {{/if}}
              <td>{{value.exposureCategory}}{{#if value.inTrendTest}}<sup>*</sup>{{/if}}</td>
              <td>{{value.numberExposed}}</td>
              <td>{{#if showPlots}}
                    {{> forestPlot parent=.. index=index }}
                  {{ else}}
                    <span title="Effect measure: {{../effectMeasure}}">{{../riskFormatter value}}</span>
                  {{/if}}
              </td>
              {{#if isEqual current=index target=0 }}
                <td rowspan="{{../riskEstimates.length}}">
                  {{commaList ../covariates}}
                </td>
                <td rowspan="{{../riskEstimates.length}}" class="dragHandle dhInner"
                    style="display: none" title="Drag to re-order rows"></td>
              {{/if}}
            </tr>
          {{/each}}
          {{#if displayTrendTest}}
            <tr><td></td><td colspan="4"><sup>*</sup>Trend-test <i>p</i>-value: {{trendTest}}</td></tr>
          {{/if}}
        </tbody>
      </table>
    </div>
  {{/if}}
</template>

<!--
Render <td>OrganSite</td> with effectUnits if they exist,
or the-first row of the riskEstimates.
-->
<template name="organSiteTd">
  <td rowspan="{{getRowspan}}">
    {{#if userCanEdit}}
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle"
                type="button" data-toggle="dropdown">
                <span class="caret" title="Editing options"></span></button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="inner-show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#" id="clone-nested-content">
              <span class="fa fa-copy"></span> Create a clone</a></li>
          <li>
            <a href="#" id="inner-toggle-hidden">{{#if isHidden}}
              <span class="glyphicon glyphicon-plus"></span> Show row
              {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
              {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{qaMark isQA}}{{organSite}}
  </td>
</template>

<template name="epiResultForm">
  <div class="modal fade" id="modalDiv" tabindex="-1" role="dialog"
       data-backdrop="static" aria-labelledby="modalDiv" aria-hidden="true">
    {{#with getObject }}   <!-- Reactive epiResult  -->
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Epidemiological results</h4>
        </div>

        <div class="modal-body">
          <form id="nestedModalForm" role="form" class="editForm">
            <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.{{>formLegendPulldown}}</p>

            <!-- First row -->
            <div class="form-group row">
              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Cancer-organ site for results being measured.">
                       &nbsp;<br>Organ site* (ICD code)</label>
                <br>
                {{> typeaheadInput name="organSite" value=organSite methodName="searchOrganSite"}}
              </div>

              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Risk metric used to display results (SMR, RR, etc.)">
                       &nbsp;<br>Measure of effect*</label>
                {{> typeaheadInput name="effectMeasure" value=effectMeasure methodName="searchEffectMeasure"}}
              </div>

              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                      data-content="Units, if relevant (e.g., risk per 10 μg/m3)">
                      Units of effect measurement, if relevant</label>
                {{> typeaheadInput name="effectUnits" value=effectUnits methodName="searchEffectUnits"}}
              </div>

              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                      data-content="Provide p-value for trend-test when reported">
                      &nbsp;<br><i>p</i>-value for trend</label>
                <input class="form-control" type="number" step="any"
                       name='trendTest'
                       value="{{trendTest}}"/>
              </div>
            </div>

            <!-- Risk estimates -->
            <table class="table table-condensed">
              <colgroup>
                <col width="8%">
                <col width="20%">
                <col width="12%">
                <col width="12%">
                <col width="12%">
                <col width="12%">
                <col width="12%">
                <col width="12%">
              </colgroup>
              <thead>
                <th style="vertical-align: middle;" class="text-center">
                    <button type="button" class="btn btn-xs btn-info"
                            id="inner-addRiskRow" title="Add row">
                            <span class="glyphicon glyphicon-plus"></span></button></th>
                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="E.g., all exposed workers, second quartile of exposure,
                                    quantitative exposure level (always provide quantitative
                                    information when available)">
                        Exposure category<br>or level*</span></th>

                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                    data-content='Deaths/cases for cohort studies;
                                  Cases for case-control studies.
                                  If unknown, enter "NR"'>
                    Exposed<br>cases/deaths*</span></th>
                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="Central risk reported for risk estimate">
                        Risk<br>estimate</span></th>
                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="95% lower confidence interval risk estimate">
                        95%<br>lower CI</span></th>
                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="95% upper confidence interval risk estimate">
                         95%<br>upper CI</span></th>
                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="Calculations by the working-group (WG), not study-authors">
                        WG calculation?</span></th>
                <th class="text-center">
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="Risk estimate included in trend-test">
                        Estimate in<br>trend-test?</span></th>
                </thead>
              <tbody class="riskEstimateTbody">
                {{#if riskEstimates}}
                  {{#each riskEstimates}}
                    {{> riskEstimateForm this}}
                  {{/each}}
                {{else}}
                  {{> riskEstimateForm}}
                {{/if}}
              </tbody>
            </table>

            <!-- Final row -->
            <div class="form-group row">

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content='List all covariates which were controlled by matching or
                                     adjustment in the analysis reported. Enter each covariate
                                     individually, and then press <enter> to add it to the list.
                                     If no covariates were specified, add "not-specified"'>
                       Covariates controlled*</label>
               {{> typeaheadSelectList name="covariates" values=covariates methodName="searchCovariates"}}
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Further describe how covariates were controlled, if needed,
                                     such as details on matching methodology or adjustments made">
                        Covariates controlled notes</label>
                <textarea class="form-control"
                          name='covariatesControlledText'
                          rows="4">{{covariatesControlledText}}</textarea>
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Note issues related to appropriateness of comparison
                                     groups, potential for uncontrolled confounding, etc.
                                     (e.g. matching criteria for case-control studies)">
                      General Notes</label>
                <textarea class="form-control"
                          name='notes'
                          rows="4">{{notes}}</textarea>
              </div>
            </div>

            <!-- NTP-only fields -->
            {{#if isNTP }}
            <div class="form-group row">

              <div class="col-xs-8">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Microsoft Word report table caption name.
                       If left-blank, results will not be printed.">
                        Table caption</label>
                {{> typeaheadInput name="printCaption" value=printCaption methodName="searchPrintCaption"}}
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Microsoft Word report table order. Rows
                       will be printed in ascending order using this field
                       (decimals allowed). If left-blank or negative,
                       results will not be printed.">
                        Table print-order</label>
                <input class="form-control" type="number" step="any"
                       name='printOrder'
                       value="{{printOrder}}"/>
              </div>

            </div>
            {{/if}}

            <div id="errors"></div>

            {{> qaNotice}}

            <!-- Submission -->
            <div class="well well-sm pager">
              {{#if isNew }}
                <button type="button" class="btn btn-sm btn-primary"
                        id="inner-create" title="Save new">
                        <span class="glyphicon glyphicon-ok"></span> Create</button>
                <button type="button" class="btn btn-sm btn-default"
                        id="inner-create-cancel" title="Cancel">Cancel</button>
              {{else}}

                {{#if isQA }}
                  <button type="button"
                          class="btn btn-sm btn-default"
                          id="inner-update-cancel"
                          title="Cancel changes">Close</button>
                  {{#if isInRole 'staff'}}
                    <button type="button"
                              id="unsetQA"
                           class="pull-right btn btn-sm btn-warning"
                           title="Unset data as QA'd and allow further changes">
                        <span class="fa fa-exclamation-circle"></span> Remove QA'd</button>
                  {{/if}}
                {{else}}
                  <button type="button" class="btn btn-sm btn-primary"
                          id="inner-update" title="Save changes">
                          <span class="glyphicon glyphicon-ok"></span> Save</button>
                  <button type="button" class="btn btn-sm btn-default"
                          id="inner-update-cancel" title="Cancel changes">Cancel</button>
                  <button type="button" class="btn btn-sm btn-danger"
                          id="inner-delete" title="Delete row">
                          <span class="glyphicon glyphicon-trash"></span></button>
                  {{#if isInRole 'staff'}}
                    <button type="button"
                              id="setQA"
                           class="pull-right btn btn-sm btn-success"
                           title="Make data as QA'd and prevent further changes">
                        <span class="fa fa-check-circle"></span> Mark QA'd</button>
                  {{/if}}
                {{/if}}
              {{/if}}
            </div>

          </form>
        </div>  <!-- Modal body -->
      </div>  <!-- Modal content -->
    </div>  <!-- Modal dialog -->
    {{/with}}  <!-- Reactive epiResult  -->
  </div>  <!-- Modal container -->
</template>

<template name="riskEstimateForm">
  <tr>
    <td class="text-center" style="vertical-align: middle;">
      <button type="button" class="btn btn-xs btn-danger"
                id="epiRiskEstimate-delete" title="Delete row">
                <span class="glyphicon glyphicon-trash"></span></button>
    </td>
    <td>
      <input class="form-control" type="text"
             name='exposureCategory'
             value="{{exposureCategory}}"/>
    </td>
    <td>
      <input class="form-control" type="text"
             name='numberExposed'
             value="{{numberExposed}}"/>
    </td>
    <td>
        <input class="form-control" type="number" step="any"
               name='riskMid'
               value="{{riskMid}}"/>
    </td>
    <td>
        <input class="form-control" type="number" step="any"
               name='riskLow'
               value="{{riskLow}}"/>
    </td>
    <td>
        <input class="form-control" type="number" step="any"
               name='riskHigh'
               value="{{riskHigh}}"/>
    </td>
    <td>
      <div class="checkbox text-center">
        <input style="margin: 0px"
               type="checkbox" name='riskEstimated'
               checked="{{riskEstimated}}"
               title="Check if risk was estimated by reviewer, not study-author"/></div></td>
    <td>
      <div class="checkbox text-center">
        <input style="margin: 0px"
               type="checkbox" name='inTrendTest'
               checked="{{inTrendTest}}"
               title="Check if risk-estimated included in trend-test"/></div></td>
  </tr>
</template>

<template name="forestPlot">
  <div>
    <svg class="epiRiskPlot" preserveAspectRatio="none" viewBox="0 0 150 20"></svg>
  </div>
</template>
