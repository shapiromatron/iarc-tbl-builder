<template name="epiMain">
  <div class="container">
    {{> epiDescriptiveTbl}}
  </div>
</template>


<template name="epiDescriptiveTbl">
  <h1>{{name}}
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#if userCanEdit}}
          {{#unless showNew}}
            <li>
              <a href="#" id="show-create">
                <span class="glyphicon glyphicon-plus"></span> Create new row</a></li>
          {{/unless}}
          <li>
            <a href="#" id="reorderRows">
              <span class="glyphicon glyphicon-align-justify"></span> Reorder rows</a></li>
        {{/if}}
        <li>
          <a href="#" id="downloadExcel">
            <span class="fa fa-file-excel-o"></span> Download Excel</a></li>

        <li>
          <a href="#" id="epiRiskShowPlots">
            {{#if showPlots}}<span class="glyphicon glyphicon-eye-close"></span> Hide risk plots
            {{else}}<span class="glyphicon glyphicon-eye-open"></span> Show risk plots
            {{/if}}</a></li>

        <li>
          <a href="#" id="toggleShowAllRows">
            {{#if isShowAll}}<span class="glyphicon glyphicon-resize-small"></span> Hide rows
            {{else}}<span class="glyphicon glyphicon-resize-full"></span> Show all rows
            {{/if}}</a></li>
      </ul>
    </div>
  </h1>

  <table id="epiDescritpiveTbl" class="evidenceTable table table-compressed">
    <colgroup>
      <col width="20%">
      <col width="10%">
      <col width="15%">
      <col width="10%">
      <col width="10%">
      <col width="15%">
      <col width="20%">
    </colgroup>
    <thead>
      <tr>
        <th>Header</th>
        <th>Header</th>
        <th>Header</th>
        <th>Header</th>
        <th>Header</th>
        <th class="riskTR">Header</th>
        <th>Header</th>
      </tr>
    </thead>
    <tbody id="sortable">
      {{#each getEpiDescriptives}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
              data-id="{{_id}}"
              data-sortIdx="{{sortIdx}}">
            {{#if isEditing}}
              <td id="editingRow" colspan="100">
                {{> epiDescriptiveForm this isNew=false}}
              </td>
            {{else}}
              {{> epiDescriptiveRow}}
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No data has been entered into this table.
            {{#unless showNew}}<br><br>
              <a href="#" class="btn btn-primary btn-sm" id="show-create">
                <span class="glyphicon glyphicon-plus"></span> Create new row</a>
            {{/unless}}
          </td>
        </tr>
      {{/each}}
    </tbody>
  </table>
<!--
  {{ drawRiskPlotAxis }}
 -->
  {{#if showNew}}
    {{> epiDescriptiveForm isNew=true}}
  {{/if}}
</template>

<template name='epiDescriptiveRow'>
  <td>
    {{#if userCanEdit}}
      <div id="epiResultDiv"></div>
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
          <span class="caret" title="Editing options"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#"
               class="addEpiResult"
               title="Display modal for entering results">
              <span class="fa fa-medkit"></span> Add results</a></li>
          <li>
            <a href="#" id="copy-as-new">
              <span class="glyphicon glyphicon-repeat"></span> Copy as new</a></li>
          <li>
              <a href="#" id="toggle-hidden">{{#if isHidden}}
                <span class="glyphicon glyphicon-plus"></span> Show row
                {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{>printReference id=referenceID}}
  </td>
  <td>Content</td>
  <td colspan="4" id="sortableInner">
    {{#each getResults}}
      {{> epiResultTbl}}
    {{else}}
      <p class="help-block">No results have been created.
        {{#if userCanEdit}}
          <a href="#"
             class="btn btn-primary btn-sm addEpiResult pull-right"
             title="Display modal for entering results">
            <span class="fa fa-medkit"></span> Add results</a>
        {{/if}}
      </p>
    {{/each }}
  </td>
  <td>Content</td>
  <td class="dragHandle dhOuter" style="display: none" title="Drag to re-order rows"></td>
</template>

<template name="epiDescriptiveForm">
  <form id="epiDescriptiveForm" role="form" class="editForm">
    <legend>Epidemiological Cohort Description</legend>
    <p class="help-block">Hover-over field labels for more descriptive text.</p>

    <!-- First row -->
    <div class="form-group row">
      <div class="col-xs-3">
        {{> referenceSingleSelect}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Study-design used for evaluation (Prospective Cohort, Case-Control, etc.) ">
              Study design</label>
        {{> selectList options=getStudyDesignOptions selected=studyDesign selectName="studyDesign" }}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Country; other information (e.g., region, state, province, city) if important">
              Location</label>
        <input class="form-control" type="text"
               name='location'
               value="{{location}}"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Enrollment for case-control studies, follow-up for cohort studies">
               Enrollment or follow-up date</label>
        <input class="form-control" type="text"
               name='enrollmentDates'
               value="{{enrollmentDates}}"/>
      </div>
    </div>

    <!-- Second row -->
    <div class="form-group row">

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Industry or occupation (e.g., transformer repair
                             workers); cohort name (e.g., Nurses' Health Study);
                             source of population (e.g., participants in the
                             population census, registered voters, source cohort
                             for nested case-control studies)">
                Population description</label>
        <textarea class="form-control"
                  name='populationDescription'
                  rows="4">{{populationDescription}}</textarea>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Any additional criteria for inclusion/exclusion
                             (e.g., age, sex, race, length of employment).
                             Provide for cases and controls in case-control studies.">
                Eligibility criteria</label>
        <textarea class="form-control"
                  name='strengths'
                  rows="4">{{strengths}}</textarea>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Approach used to estimate exposure, if any
                            (quantitative measurement, JEM questionnaire, expert
                            judgement, biomonitoring, other)">
              Exposure assessment method</label>
        <textarea class="form-control"
                  name='exposureAssessmentMethod'
                  rows="4">{{exposureAssessmentMethod}}</textarea>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Method of follow-up or source of outcome data (e.g.
                            linkage to natinoal cancer registry, searches of
                            death certificates, insurace records, etc.)">
              Outcome data source</label>
        <textarea class="form-control"
                  name='outcomeDataSource'
                  rows="4">{{outcomeDataSource}}</textarea>
      </div>
    </div>

    <!-- Third row -->
    <div class="form-group row">

      <div class="col-xs-4 isNotCCinput">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Number enrolled for cohort studies which were
                             included in the analysis after exclusions">
               Population size</label>
        <input class="form-control" type="number"
               name='populationSize'
               value="{{populationSize}}"/>
      </div>
      <div class="col-xs-3 isCCinput">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Number of cases in case-control study which were
                             included in the analysis after exclusions">
               Cases: population size</label>
        <input class="form-control" type="number"
               name='populationSizeCase'
               value="{{populationSizeCase}}"/>
      </div>
      <div class="col-xs-3 isCCinput">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Number of controls in case-control study which were
                             included in the analysis after exclusions">
               Controls: population size</label>
        <input class="form-control" type="number"
               name='populationSizeControl'
               value="{{populationSizeControl}}"/>
      </div>

      <div class="col-xs-6 isCCinput">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Note disease definition and whether incident for
                             cases. For hospital clinical/registry controls note
                             disease(s) if relevant (e.g., other cancers, non-
                             smoking related disease)">
                Source of cases and controls</label>
        <textarea class="form-control"
                  name='sourceCaseControls'
                  rows="2">{{sourceCaseControls}}</textarea>
      </div>
    </div>

    <!-- Fourth row -->
    <div class="form-group row">

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Percent of eligible participants included
                            (for cases and controls in case-control studies)">
              Response rates</label>
        <input class="form-control" type="number" step="any"
               name='responseRate'
               value="{{responseRate}}"
               placeholder="Leave blank if unknown"/>
      </div>


      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Enrollment for case-control studies, follow-up for cohort studies">
               Type of referent group</label>
        <input class="form-control" type="text"
               name='referentGroup'
               value="{{referentGroup}}"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Average exposure level or range">
               Exposure level</label>
        <input class="form-control" type="text"
               name='exposureLevel'
               value="{{exposureLevel}}"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
               data-content="e.g., multiple logistic regression, lifetable, Mantel-Haenzel, etc.">
               Analytical method</label>
        <input class="form-control" type="text"
               name='analyticalMethod'
               value="{{analyticalMethod}}"/>
      </div>
    </div>

    <!-- Fifth row -->
    <div class="form-group row">

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Any study-strengths should be described here.">
                Principal strengths</label>
        <textarea class="form-control"
                  name='strengths'
                  rows="3">{{strengths}}</textarea>
      </div>

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Limitations to consider include the extent to which
                             chance, bias, and confounding could explain the results">
                Principal limitations</label>
        <textarea class="form-control"
                  name='limitations'
                  rows="3">{{limitations}}</textarea>
      </div>

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Any other general comments related to the study">
              General Notes</label>
        <textarea class="form-control"
                  name='notes'
                  rows="3">{{notes}}</textarea>
      </div>
    </div>

    <div id="errors"></div>

    <!-- Submission -->
    <div class="well well-sm pager">
      {{#if isNew }}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="create"
                title="Save new">
                <span class="glyphicon glyphicon-ok"></span> Create</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="create-cancel"
                title="Cancel">Cancel</button>
      {{else}}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="update"
                title="Save changes">
                <span class="glyphicon glyphicon-ok"></span> Save</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="update-cancel"
                title="Cancel changes">Cancel</button>
        <button type="button"
                class="btn btn-sm btn-danger"
                id="delete" title="Delete row">
                <span class="glyphicon glyphicon-trash"></span></button>
        <button type ="button"
                id   ="addEpiResult"
                class="pull-left btn btn-sm btn-primary"
                title="Display modal for entering results">
                <span class="fa fa-medkit"></span> Add results</button>
      {{/if}}
    </div>
  </form>
  <!-- Add input form-modals outside form scope -->
  {{> referenceQuickAddModal}}
  <div id="epiResultDiv"></div>
</template>

<template name="epiResultTbl">
  {{#if showRow isHidden}}
    <div class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
        data-id="{{_id}}"
        data-sortIdx="{{sortIdx}}">

    <table class="table table-condensed nestedTbl">
      <colgroup>
        <col width="30%">
        <col width="20%">
        <col width="20%">
        <col width="30%">
      </colgroup>
      <tbody>
        {{#each eachIndex riskEstimates}}
          <tr>
            {{#if isEqual current=index target=0 }}
              <td rowspan="{{../riskEstimates.length}}">
                {{#if userCanEdit}}
                  <div id="epiResultDiv"></div>
                  <div class="rowOptions btn-group pull-right">
                    <button class="btn btn-default btn-xs dropdown-toggle"
                            type="button" data-toggle="dropdown">
                            <span class="caret" title="Editing options"></span></button>
                    <ul class="dropdown-menu">
                      <li><a href="#" id="inner-show-edit">
                          <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                      <li><a href="#" id="inner-toggle-hidden">{{#if ../isHidden}}
                        <span class="glyphicon glyphicon-plus"></span> Show row
                        {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                        {{/if}}</a>
                      </li>
                      <li><a href="#" id="inner-copy-as-new">
                          <span class="glyphicon glyphicon-repeat"></span> Copy as new</a></li>
                    </ul>
                  </div>
                {{/if}}
                {{../cancerSite}}
              </td>
              <td rowspan="{{../riskEstimates.length}}">{{../numberExposed}}</td>
            {{/if}}
            <td>{{value.exposureCategory}}</td>
            <td>{{{riskFormat value}}}</td>
            {{#if isEqual current=index target=0 }}
              <td rowspan="{{../riskEstimates.length}}" class="dragHandle dhInner"
                  style="display: none" title="Drag to re-order rows"></td>
            {{/if}}
          </tr>
        {{/each}}
      </tbody>
    </table>

  </div>
  {{/if}}

</template>

<template name="epiResultForm">
  <div class="modal fade" id="epiResultsModal" tabindex="-1" role="dialog"
       aria-labelledby="epiResultsModal" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title" id="epiResultsModal">Results data capture</h4>
        </div>

        <div class="modal-body">
          <form id="epiResultForm" role="form" class="editForm">
            <p class="help-block">Hover-over field labels for more descriptive text.</p>

            <!-- First row -->
            <div class="form-group row">
              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Cancer site for results being measured.">
                       Cancer Site<br>&nbsp;</label>
                <br>
                <input class="form-control" type="text"
                       name='cancerSite'
                       value="{{cancerSite}}"
                       placeholder="dropdown-list"/>
              </div>

              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                      data-content="Units, if relevant (e.g., risk per 10 μg/m3)">
                      Units of effect measurement</label>
                <input class="form-control" type="text"
                       name='effectUnits'
                       value="{{effectUnits}}"
                       placeholder="dropdown-list"/>
              </div>

              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Risk metric used to display results (SMR, RR, etc.)">
                       Description of effect measure</label>
                <input class="form-control" type="text"
                       name='effectMeasure'
                       value="{{effectMeasure}}"
                       placeholder="dropdown-list"/>
              </div>

              <div class="col-xs-3">
                <label class="helpPopovers" data-toggle="popover"
                      data-content="Trend test, provide for categorical analysis when reported">
                      Trend test<br>&nbsp;</label>
                <input class="form-control" type="number" step="any"
                       name='trendTest'
                       value="{{trendTest}}"/>
              </div>
            </div>

            <!-- Risk estimates -->
            <table class="table table-condensed">
              <thead>
                <th>
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="E.g., all exposed workers, second quartile of exposure,
                                    quantitative exposure level (always provide quantitative
                                    information when available)">
                        Exposure category<br>or level</span></th>

                <th>
                  <span class="helpPopovers" data-toggle="popover"
                    data-content="Deaths/cases for cohort studies; Cases for case-control studies">
                    Number exposed<br>&nbsp;</span></th>
                <th>
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="Central risk reported for risk estimate">
                        Risk estimate<br>midpoint</span></th>
                <th>
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="95% lower confidence interval risk estimate">
                        Risk estimate<br>95% lower CI</span></th>
                <th>
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="95% upper confidence interval risk estimate">
                         Risk estimate<br>95% upper CI</span></th>
                <th>
                  <span class="helpPopovers" data-toggle="popover"
                        data-content="Risk was estimated by reviewers, not study-authors">
                        Estimated<br>&nbsp;</span></th>
                <th>
                    <button type="button" class="btn btn-xs btn-info"
                            id="inner-addRiskRow" title="Add row">
                            <span class="glyphicon glyphicon-plus"></span></button></th>
              </thead>
              <tbody class="riskEstimateTbody">
                {{#if riskEstimates}}
                  {{#each riskEstimates}}
                    {{> riskEstimateForm this}}
                  {{/each}}
                {{else}}
                  {{> riskEstimateForm}}
                {{/if}}
              </tbody>
            </table>

            <!-- Final row -->
            <div class="form-group row">

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="List all covariates which were controlled by matching or
                                     adjustment in the analysis reported">
                       Covariates controlled</label>
               {{> typeaheadSelectList name="covariates" values=covariates data_source="searchCovariates"}}
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Further describe how covariates were controlled, if needed,
                                     such as details on matching methodology or adjustments made">
                        Covariates controlled notes</label>
                <textarea class="form-control"
                          name='covariatesControlledText'
                          rows="4">{{covariatesControlledText}}</textarea>
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Note issues related to appropriateness of comparison
                                     groups, potential for uncontrolled confounding, etc.">
                      General Notes</label>
                <textarea class="form-control"
                          name='notes'
                          rows="4">{{notes}}</textarea>
              </div>
            </div>

            <div id="errors"></div>

            <!-- Submission -->
            <div class="well well-sm pager">
              {{#if isNew }}
                <button type="button" class="btn btn-sm btn-primary"
                        id="inner-create" title="Save new">
                        <span class="glyphicon glyphicon-ok"></span> Create</button>
                <button type="button" class="btn btn-sm btn-default"
                        id="inner-create-cancel" title="Cancel">Cancel</button>
              {{else}}
                <button type="button" class="btn btn-sm btn-primary"
                        id="inner-update" title="Save changes">
                        <span class="glyphicon glyphicon-ok"></span> Save</button>
                <button type="button" class="btn btn-sm btn-default"
                        id="inner-update-cancel" title="Cancel changes">Cancel</button>
                <button type="button" class="btn btn-sm btn-danger"
                        id="inner-delete" title="Delete row">
                        <span class="glyphicon glyphicon-trash"></span></button>
              {{/if}}
            </div>

          </form>
        </div>  <!-- Modal body -->
      </div>  <!-- Modal content -->
    </div>  <!-- Modal dialog -->
  </div>  <!-- Modal container -->
</template>

<template name="riskEstimateForm">
  <tr>
    <td>
      <input class="form-control" type="text"
             name='exposureCategory'
             value="{{exposureCategory}}"/>
    </td>
    <td>
      <input class="form-control" type="number"
             name='numberExposed'
             value="{{numberExposed}}"/>
    </td>
    <td>
        <input class="form-control" type="number" step="any"
               name='riskMid'
               value="{{riskMid}}"/>
    </td>
    <td>
        <input class="form-control" type="number" step="any"
               name='riskLow'
               value="{{riskLow}}"/>
    </td>
    <td>
        <input class="form-control" type="number" step="any"
               name='riskHigh'
               value="{{riskHigh}}"/>
    </td>
    <td>
      <div class="checkbox">
        <input type="checkbox" name='riskEstimated'
               checked="{{riskEstimated}}"
               title="Check if risk was estimated by reviewer, not study-author"/>
      </div>
    </td>
    <td class="text-center" style="vertical-align: middle;">
      <button type="button" class="btn btn-xs btn-danger"
                id="epiRiskEstimate-delete" title="Delete row">
                <span class="glyphicon glyphicon-trash"></span></button>
    </td>
  </tr>
</template>
