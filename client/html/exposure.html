<template name="exposureMain">
  <div class="{{getContainerClass}}">
    {{> exposureTbl}}
  </div>
</template>


<template name="exposureTbl">
  <h1>{{name}}
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        Actions <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#if userCanEdit}}
          {{#unless showNew}}
            <li>
              <a href="#" id="show-create">
                <span class="glyphicon glyphicon-plus"></span> Create new row</a></li>
          {{/unless}}
          <li>
            <a href="#" id="reorderRows">
              <span class="glyphicon glyphicon-align-justify"></span> Reorder rows</a></li>
        {{/if}}
        <li> {{> optFullScreen}} </li>
        <li>
          <a href="#" id="downloadExcel">
            <span class="fa fa-file-excel-o"></span> Download Excel</a></li>
        <li>
          <a href="#" id="wordReport">
            <span class="fa fa-file-word-o"></span> Download Word</a></li>
        <li>
          <a href="#" id="toggleShowAllRows">
            {{#if isShowAll}}<span class="glyphicon glyphicon-resize-small"></span> Hide rows
            {{else}}<span class="glyphicon glyphicon-resize-full"></span> Show all rows
            {{/if}}</a></li>
        <li>
          <a href="#" id="toggleQAflags">
            <span class="fa fa-flag-o"></span> Toggle QA flags</a></li>
      </ul>
    </div>
  </h1>
  <p class="help-block">{{tableTitle}}</p>

  <table class="evidenceTable table table-compressed">
    <colgroup>
      <col width="15%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="15%">
      <col width="10%">
      <col width="30%">
    </colgroup>
    <thead>
      <tr>
        <th>Reference,<br>agent collected,<br>exposure-scenario</th>
        <th>Location, <br>collection date</th>
        <th>Occupation description</th>
        <th>Sampling<br>matrix</th>
        <th>Exposure level</th>
        <th>Exposure range</th>
        <th>Comments/additional data</th>
      </tr>
    </thead>
    <tbody id="sortable">
      {{#each object_list}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
              data-id="{{_id}}"
              data-sortIdx="{{sortIdx}}">
            {{#if isEditing}}
              <td id="editingRow" colspan="100">
                {{> exposureForm this isNew=false}}
              </td>
            {{else}}
              {{> exposureRow}}
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No data has been entered into this table.</td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{#if userCanEdit}}
    {{#unless showNew}}<br><br>
    <a href="#" class="btn btn-primary btn-sm" id="show-create">
      <span class="glyphicon glyphicon-plus"></span> Create new row</a>
    {{/unless}}
  {{/if}}

  {{#if showNew}}
    {{> exposureForm isNew=true}}
  {{/if}}

  <div id="modalHolder"></div>
</template>


<template name='exposureRow'>
  <td>
    {{#if userCanEdit}}
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
          <span class="caret" title="Editing options"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#" id="clone-content">
              <span class="fa fa-copy"></span> Create a clone</a></li>
          <li>
            <a href="#" id="move-content">
              <span class="fa fa-arrow-circle-right"></span> Move to a different table</a></li>
          <li>
              <a href="#" id="toggle-hidden">{{#if isHidden}}
                <span class="glyphicon glyphicon-plus"></span> Show row
                {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{qaMark isQA}}
    {{>printReference id=referenceID}}<br>
    <span class="text-muted">{{exposureScenario}}</span><br>
    {{agent}}
  </td>
  <td>
    {{country}}<br>
    {{#if location}}
      <span class="text-muted">{{location}}</span><br>
    {{/if}}
    {{collectionDate}}
  </td>
  <td>

    {{#if isOccupational}}
      {{occupation}}<br>
      {{#if occupationInfo}}
        <span class="text-muted">{{occupationInfo}}</span>
      {{/if}}
    {{else}}
      N/A
    {{/if}}
  </td>
  <td>
    {{samplingMatrix}}
  </td>
  <td>
    {{exposureLevel}} {{units}}<br>
    <span class="text-muted">{{exposureLevelDescription}}</span>
  </td>
  <td>
    {{exposureLevelRange}} {{units}}
  </td>
  <td>
    {{comments}}
  </td>
  <td class="dragHandle dhOuter" style="display: none" title="Drag to re-order rows"></td>
</template>


<template name="exposureForm">
  <form id="mainForm" role="form" class="editForm">
    <legend>Exposure evidence {{>formLegendPulldown}}</legend>
    <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.</p>

    <!-- First row -->
    <div class="form-group row">
      <div class="col-xs-3">
        {{> referenceSingleSelect}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Type of exposure-information collected">
              Exposure scenario*</label>
        {{> selectList options=getExposureScenario selected=exposureScenario selectName="exposureScenario" }}

        <br>
        <label class="helpPopovers" data-toggle="popover"
              data-content="Year(s) of data collection">
              Collection date*</label>
        <input class="form-control" type="text"
               name='collectionDate'
               value="{{collectionDate}}"
               placeholder="e.g. 2009-2011"/>
      </div>

      <div class="col-xs-3 isOcc">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Industry/occupation for occupational exposure">
              Industry or occupation*</label>
        <input class="form-control" type="text"
               name='occupation'
               value="{{occupation}}"
               placeholder="e.g. Bitumen production"/>

        <br>
        <label class="helpPopovers" data-toggle="popover"
              data-content="Other information (e.g., job task, etc.) if important">
              Other occupational information</label>
        <input class="form-control" type="text"
               name='occupationInfo'
               value="{{occupationInfo}}"
               placeholder="e.g. Tar distillation"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Country of exposure measurement">
              Country*</label>
        {{> typeaheadInput name="country" value=country methodName="searchCountries" placeholder="e.g. France"}}

        <br>
        <label class="helpPopovers" data-toggle="popover"
              data-content="Other information
                            (e.g., region, state, province, city) if important">
              Other location information</label>
        <input class="form-control" type="text"
               name='location'
               value="{{location}}"
               placeholder="e.g. Montpellier"/>
      </div>
    </div>

    <!-- Second row -->
    <div class="form-group row">
      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="The substance or exposure that was measured
                            (e.g., PM-10, TCE, Total PCB)">
              <br>Agent*</label>
        {{> typeaheadInput name="agent" value=agent methodName="searchAgents" placeholder="e.g. PM-10"}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="The environmental medium or other matrix
                            (e.g., air, drinking water, food, urine, blood)
                            in which the agent was measured">
              <br>Sampling matrix*</label>
        {{> typeaheadInput name="samplingMatrix" value=samplingMatrix methodName="searchSamplingMatrices" placeholder="e.g. air"}}
      </div>

      <div class="col-xs-2">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Approach used to collect samples">
              <br>Sampling approach*</label>
        {{> selectList options=getSamplingApproach selected=samplingApproach selectName="samplingApproach" }}
      </div>

      <div class="col-xs-2">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Typically the number of samples for environmental
                            sampling, or the number of individuals sampled if
                            personal sampling (if >1 measurement/person, give
                            total measurements and explain in the comment-box)">
              Number of<br>measurements*</label>
        <input class="form-control" type="text"
               name='numberMeasurements'
               value="{{numberMeasurements}}"
               placeholder="e.g. 3"/>
      </div>

      <div class="col-xs-2">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Mean or range; NR if not reported; NA if not applicable">
              <br>Measurement duration*</label>
        <input class="form-control" type="text"
               name='measurementDuration'
               value="{{measurementDuration}}"
               placeholder="e.g. NR"/>
      </div>
    </div>

    <!-- Third row -->
    <div class="form-group row">

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Quantitative level or NR if not reported.
                            Geometric mean preferred if available.">
              Mean or median<br>exposure-level*</label>
        <input class="form-control" type="text"
               name='exposureLevel'
               value="{{exposureLevel}}"
               placeholder="e.g. 12.35"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Statistic used to describe exposure-level">
              Description of<br>exposure-level*</label>
        {{> selectList options=getExposureLevelDescription selected=exposureLevelDescription selectName="exposureLevelDescription" }}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Minimum and maximum or NR if not reported.
                            Optionally if range not reported the standard-deviation
                            or other measure of variability relative to the mean.
                            (e.g., 32.3-40.2, NR, 13.2 SD, 14.7 SE)">
              Range of<br>exposure-level*</label>
        <input class="form-control" type="text"
               name='exposureLevelRange'
               value="{{exposureLevelRange}}"
               placeholder="e.g. 32.3-40.2"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Measurement units (e.g. µg/m³, g/m²)">
              <br>Units*</label>
        {{> typeaheadInput name="units" value=units methodName="searchUnits" placeholder="e.g. µg/m³"}}
      </div>
    </div>

    <!-- Fourth row -->
    <div class="form-group row">
      <div class="col-xs-12">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Other relevant information or Working Group comments">
              Additional information/comments</label>
        <textarea class="form-control"
                  name='comments'
                  rows="2">{{comments}}</textarea>
      </div>
    </div>

    <div id="errors"></div>

    <!-- QA notice -->
    {{#if isQA }}
      <strong>{{QAstampFormat timestampQA user_id_QA}}</strong>
    {{/if}}

    <!-- Submission -->
    <div class="well well-sm pager">
      {{#if isNew }}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="create"
                title="Save new">
                <span class="glyphicon glyphicon-ok"></span> Create</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="create-cancel"
                title="Cancel">Cancel</button>
      {{else}}
        {{#if isQA }}
          <button type="button"
                  class="btn btn-sm btn-default"
                  id="update-cancel"
                  title="Cancel changes">Close</button>
          {{#if isInRole 'staff'}}
            <button type ="button"
                      id   ="unsetQA"
                      class="pull-right btn btn-sm btn-warning"
                      title="Unset data as QA'd and allow further changes">
                      <span class="fa fa-exclamation-circle"></span> Remove QA'd</button>
          {{/if}}
        {{else}}
          <button type="button"
                  class="btn btn-sm btn-primary"
                  id="update"
                  title="Save changes">
                  <span class="glyphicon glyphicon-ok"></span> Save</button>
          <button type="button"
                  class="btn btn-sm btn-default"
                  id="update-cancel"
                  title="Cancel changes">Cancel</button>
          <button type="button"
                  class="btn btn-sm btn-danger"
                  id="delete" title="Delete row">
                  <span class="glyphicon glyphicon-trash"></span></button>
          {{#if isInRole 'staff'}}
            <button type ="button"
                    id   ="setQA"
                    class="pull-right btn btn-sm btn-success"
                    title="Make data as QA'd and prevent further changes">
                    <span class="fa fa-check-circle"></span> Mark QA'd</button>
          {{/if}}
        {{/if}}
      {{/if}}
    </div>
  </form>
  <!-- Add input form-modals outside form scope -->
  {{> referenceQuickAddModal}}
</template>
