<template name="ntpEpiMain">
  {{#if Template.subscriptionsReady}}
    {{#contentContainer}}
      {{> ntpEpiDescTbl}}
    {{/contentContainer}}
  {{else}}
    {{> isLoading}}
  {{/if }}
</template>


<template name="ntpEpiDescOpts">
  {{#actionBtn}}
    {{#if userCanEdit}}
      {{#unless showNew}}
        {{> optCreate }}
      {{/unless}}
      {{> optReorder }}
    {{/if}}
    {{> optMonoRefList}}
    {{> optFullScreen}}
    {{> optExcel }}
    {{> optWord }}
    {{> optRiskPlot}}
    {{> optShowAllRows}}
    {{> optQaFlags}}
    <li>
      <a href="{{pathFor 'ntpEpiRatingMain' _id=this._id}}">
        <i class="fa fa-star-half-o"></i> View ratings</a></li>
  {{/actionBtn}}
</template>


<template name="ntpEpiDescTbl">
  <h1>{{name}} {{> ntpEpiDescOpts}}</h1>
  {{> tableTitle}}
  <table class="evidenceTable table table-compressed">
    <colgroup>
      <col width="15%">
      <col width="15%">
      <col width="10%">
      <col width="11%">
      <col width="06%">
      <col width="12%">
      <col width="10%">
      <col width="21%">
    </colgroup>
    <thead>
      <tr>
        <th>Reference, location, follow-up/enrollment period, study-design</th>
        <th>Population size, description, exposure assessment method</th>
        <th>Organ site</th>
        <th>Exposure category<br> or level</th>
        <th>Exposed<br>cases/<br>deaths</th>
        <th class="riskTR">Risk estimate<br>(95% CI)</th>
        <th>Covariates controlled</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody id="sortable">
      {{#each object_list}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
              data-id="{{_id}}"
              data-sortIdx="{{sortIdx}}">
            {{#if isEditing}}
              <td id="editingRow" colspan="100">
                {{> ntpEpiDescriptiveForm this isNew=false}}
              </td>
            {{else}}
              {{> ntpEpiDescriptiveRow}}
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No data has been entered into this table.</td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{> showNewBtn }}

  {{#if showNew}}
    {{> ntpEpiDescriptiveForm isNew=true}}
  {{/if}}
</template>


<template name="ntpEpiDescriptiveRow">
  <td>
    {{#if userCanEdit}}
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
          <span class="caret" title="Editing options"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#"
               class="add-nested"
               title="Display modal for entering results">
              <span class="fa fa-medkit"></span> Add results</a></li>
          <li>
            <a href="#" id="clone-content">
              <span class="fa fa-copy"></span> Create a clone</a></li>
          <li>
            <a href="#" id="move-content">
              <span class="fa fa-arrow-circle-right"></span> Move to a different table</a></li>
          <li>
              <a href="#" id="toggle-hidden">{{#if isHidden}}
                <span class="glyphicon glyphicon-plus"></span> Show row
                {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{qaMark isQA}}
    {{>printReference id=referenceID}}
  </td>
  <td>b</td>
  <td>c</td>
  <td>d</td>
  <td>e</td>
  <td>f</td>
  <td>g</td>
  <td>h</td>
</template>


<template name="ntpEpiDescriptiveForm">
  <form id="mainForm" role="form" class="editForm">
    <legend>Epidemiological study description
      <button class="pull-right btn btn-default btn-xs dropdown-toggle"
              type="button"
              title="Expand/collapse all input form sections"
              id="toggleAccordian">
        {{#if allAccordiansShown}}
          <i class="fa fa-minus-square-o"></i>
        {{else}}
          <i class="fa fa-plus-square-o"></i>
        {{/if}}
      </button>
      {{>formLegendPulldown}}
    </legend>
    <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.</p>
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">

      <!-- General information -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#generalInfo" aria-expanded="false" aria-controls="generalInfo">
              General information
            </a>
          </h4>
        </div>
        <div id="generalInfo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <div class="form-group row">
              <div class="col-xs-3">
                <br>{{> referenceSingleSelect}}
              </div>
              <div class="col-xs-3">
                <br>{{> referenceMultiSelect label="Additional references" name="additionalReferences" values=additionalReferences }}
              </div>
              <div class="col-xs-3">
                <br>{{> fldSelectSingle name="studyDesign" value=studyDesign }}
              </div>
              <div class="col-xs-3">
                <br>{{> fldInputText name="location" value=location }}
                <div class="isntCohort">
                  {{> fldInputText name="enrollmentDates" value=enrollmentDates }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Population -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#population" aria-expanded="false" aria-controls="population">
              Population
            </a>
          </h4>
        </div>
        <div id="population" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <!-- Cohort -->
            <h5 class="isntCC">Cohort details</h5>
            <div class="form-group row isntCC">
              <div class="col-xs-3">
                {{>fldTextArea name="populationEligibility" value=populationEligibility }}
              </div>
              <div class="col-xs-3">
                {{>fldInputText name="cohortPopulationSize" value=cohortPopulationSize }}
              </div>
              <div class="col-xs-3">
                {{>fldInputText name="referentGroup" value=referentGroup }}
              </div>
              <div class="col-xs-3">
                {{>fldInputText name="lossToFollowUp" value=lossToFollowUp }}
              </div>
              <div class="col-xs-3 isCohort">
                {{>fldInputText name="smrAllCauses" value=smrAllCauses }}
              </div>
            </div>

            <!-- Case-control -->
            <h5 class="isntCohort">Case-control details</h5>
            <div class="form-group row isntCohort">
              <div class="col-xs-12">
                <!-- Header labels -->
                <div class="row">
                  <div class="col-xs-1">
                  </div>
                  <div class="col-xs-3">
                    {{>fldLabel name="populationSizeCases"}}
                  </div>
                  <div class="col-xs-3">
                    {{>fldLabel name="responseRateCases"}}
                  </div>
                  <div class="col-xs-5">
                    {{>fldLabel name="selectionDescriptionCases"}}
                  </div>
                </div>

                <!-- Case-control inputs -->
                <div class="row">
                  <div class="col-xs-1">
                    <strong>Cases</strong><br><br><br>
                    <strong>Controls</strong>
                  </div>
                  <div class="col-xs-3">
                    {{> fldInputText name="populationSizeCases" value=populationSizeCases hideLabel=true }}
                    <br>
                    {{> fldInputText name="populationSizeControls" value=populationSizeControls hideLabel=true }}
                  </div>
                  <div class="col-xs-3">
                    {{> fldInputText name="responseRateCases" value=responseRateCases hideLabel=true }}
                    <br>
                    {{> fldInputText name="responseRateControls" value=responseRateControls hideLabel=true }}
                  </div>
                  <div class="col-xs-5">
                    {{> fldTextArea name="selectionDescriptionCases" value=selectionDescriptionCases hideLabel=true }}
                    {{> fldTextArea name="selectionDescriptionControls" value=selectionDescriptionControls hideLabel=true }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Cohort + case-control -->
            <div class="form-group row">
              <div class="col-xs-3">
                {{>fldTextArea name="otherPopulationDescriptors" value=otherPopulationDescriptors }}
              </div>
              <div class="col-xs-3">
                {{> fldSelectSingle name="selectionBiasRating" value=selectionBiasRating }}
                {{> fldTextArea name="selectionBiasRationale" value=selectionBiasRationale }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Exposure and outcome -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#exposureOutcome" aria-expanded="false" aria-controls="exposureOutcome">
              Exposure and outcome
            </a>
          </h4>
        </div>
        <div id="exposureOutcome" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <div class="form-group row">
              <div class="col-xs-3">
                {{> fldSelectSingle name="exposureAssessmentType" value=exposureAssessmentType }}
                {{> fldTextArea name="exposureAssessmentNotes" value=exposureAssessmentNotes }}
                {{> fldTextArea name="exposureMissingData" value=exposureMissingData }}
              </div>
              <div class="col-xs-3">
                {{> fldSelectSingle name="exposureAssessmentRating" value=exposureAssessmentRating }}
                {{> fldTextArea name="exposureAssessmentRationale" value=exposureAssessmentRationale }}
              </div>
              <div class="col-xs-3">
                {{> fldTextArea name="outcomeDataSource" value=outcomeDataSource }}
                {{> fldTextArea name="outcomeMissingData" value=outcomeMissingData }}
              </div>
              <div class="col-xs-3">
                {{> fldSelectSingle name="outcomeAssessmentRating" value=outcomeAssessmentRating }}
                {{> fldTextArea name="outcomeAssessmentRationale" value=outcomeAssessmentRationale }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Analysis and reporting -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#analysisReporting" aria-expanded="false" aria-controls="analysisReporting">
              Analysis and reporting
            </a>
          </h4>
        </div>
        <div id="analysisReporting" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <div class="form-group row">
              <div class="col-xs-4">
                {{> fldTextArea name="analyticalMethods" value=analyticalMethods }}
              </div>
              <div class="col-xs-4">
                {{> fldSelectSingle name="analysisRating" value=analysisRating }}
                {{> fldTextArea name="analysisRationale" value=analysisRationale }}
              </div>
              <div class="col-xs-4">
                {{> fldSelectSingle name="selectiveReportingRating" value=selectiveReportingRating }}
                {{> fldTextArea name="selectiveReportingRationale" value=selectiveReportingRationale }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sensitivity -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#sensitivity" aria-expanded="false" aria-controls="sensitivity">
              Sensitivity
            </a>
          </h4>
        </div>
        <div id="sensitivity" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <div class="form-group row">
              <div class="col-xs-4">
                {{> fldInputText name="exposureLevel" value=exposureLevel }}
                {{> fldTextArea name="exposedCasesOrPower" value=exposedCasesOrPower }}
              </div>
              <div class="col-xs-4">
                <div class="isCohort">
                  {{> fldInputText name="followUp" value=followUp }}
                  {{> fldTextArea name="sensitivityOther" value=sensitivityOther }}
                </div>
              </div>
              <div class="col-xs-4">
                {{> fldSelectSingle name="sensitivityRating" value=sensitivityRating }}
                {{> fldTextArea name="sensitivityRatingRationale" value=sensitivityRatingRationale }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Study judgment -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#studyJudgment" aria-expanded="false" aria-controls="studyJudgment">
              Study judgment
            </a>
          </h4>
        </div>
        <div id="studyJudgment" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <div class="form-group row">
              <div class="col-xs-4">
                {{> fldTextArea name="strengths" value=strengths }}
              </div>
              <div class="col-xs-4">
                {{> fldTextArea name="limitations" value=limitations }}
              </div>
              <div class="col-xs-4">
                {{> fldSelectSingle name="overallUtility" value=overallUtility }}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Confounding -->
      <div>
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title">
            <a class="collapsed" role="button" data-toggle="collapse" data-parent="#accordion" href="#confounding" aria-expanded="false" aria-controls="confounding">
              Confounding
            </a>
          </h4>
        </div>
        <div id="confounding" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree" aria-expanded="false">
          <div class="panel-body">
            <div class="form-group row">
              <div class="isntCohort col-xs-3">
                {{> fldTypeaheadSelectMultiple name="caseControlMatching" values=caseControlMatching }}
                {{> fldTypeaheadSelectMultiple name="caseControlDiffers" values=caseControlDiffers }}
              </div>
              <div class="col-xs-3">
                {{> fldTypeaheadSelectMultiple name="coexposures" values=coexposures }}
                {{> fldTypeaheadSelectMultiple name="riskFactors" values=riskFactors }}
              </div>
              <div class="col-xs-3">
                {{> fldSelectSingle name="confoundingRating" value=confoundingRating }}
                {{> fldTextArea name="confoundingRatingRationale" value=confoundingRatingRationale }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="errors"></div>
    {{> qaNotice}}
    {{> evidenceFormSubmissionDiv }}
  </form>
    <!-- Add input form-modals outside form scope -->
  {{> referenceQuickAddModal}}
</template>


<template name="ntpEpiResultForm">
  <div class="modal fade" id="modalDiv" tabindex="-1" role="dialog"
       data-backdrop="static" aria-labelledby="modalDiv" aria-hidden="true">
    {{#with getObject }}   <!-- Reactive ntpEpiResult  -->
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Epidemiological results{{> objectLastUpdated}}</h4>
        </div>

        <div class="modal-body">
          <form id="nestedModalForm" role="form" class="editForm">
            <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.{{>formLegendPulldown}}</p>

            <!-- First row -->
            <div class="form-group row">
              <div class="col-xs-3">
                <br>{{> fldInputTypeahead name="organSite" value=organSite nested=true }}
              </div>
              <div class="col-xs-3">
                <br>{{> fldInputTypeahead name="effectMeasure" value=effectMeasure nested=true }}
              </div>
              <div class="col-xs-3">
                {{> fldInputTypeahead name="effectUnits" value=effectUnits nested=true }}
              </div>
              <div class="col-xs-3">
                <br>{{> fldInputFloat name="trendTest" value=trendTest nested=true }}
              </div>
            </div>

            <!-- Risk estimates -->
            <table class="table table-condensed">
              <colgroup>
                <col width="10%">
                <col width="20%">
                <col width="12%">
                <col width="12%">
                <col width="12%">
                <col width="12%">
                <col width="11%">
                <col width="11%">
              </colgroup>
              <thead>
                <th style="vertical-align: middle;" class="text-center">
                  <button type="button"
                          class="btn btn-xs btn-info"
                          id="inner-addRiskRow" title="Add row">
                    <span class="glyphicon glyphicon-plus"></span>
                  </button>
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.exposureCategory" nested=true }}
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.numberExposed" nested=true }}
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.riskMid" nested=true }}
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.riskLow" nested=true }}
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.riskHigh" nested=true }}
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.riskEstimated" nested=true }}
                </th>
                <th class="text-center">
                  {{> fldLabel name="riskEstimates.$.inTrendTest" nested=true }}
                </th>
              </thead>
              <tbody class="riskEstimateTbody">
                {{#if riskEstimates}}
                  {{#each riskEstimates}}
                    {{> riskEstimateForm this}}
                  {{/each}}
                {{else}}
                  {{> riskEstimateForm}}
                {{/if}}
              </tbody>
            </table>

            <!-- Third row -->
            <div class="form-group row">
              <div class="col-xs-4">
                {{> fldTypeaheadSelectMultiple name="covariates" values=covariates nested=true }}
              </div>
              <div class="col-xs-4">
                {{> fldTextArea name="covariatesControlledText" value=covariatesControlledText nested=true }}
              </div>
              <div class="col-xs-4">
                {{> fldTextArea name="notes" value=notes nested=true }}
              </div>
            </div>

            <div id="errors"></div>
            {{> qaNotice}}
            {{> nestedEvidenceFormSubmissionDiv}}
          </form>
        </div>  <!-- Modal body -->
      </div>  <!-- Modal content -->
    </div>  <!-- Modal dialog -->
    {{/with}}  <!-- Reactive epiResult  -->
  </div>  <!-- Modal container -->
</template>
