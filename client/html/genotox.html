<template name="genotoxMain">
  {{#if Template.subscriptionsReady}}
    {{#contentContainer}}
      {{> genotoxTbl}}
    {{/contentContainer}}
  {{else}}
    {{> isLoading}}
  {{/if }}
</template>


<template name="genotoxTbl">
  <h1>{{name}}
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        Actions <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#if userCanEdit}}
          {{#unless showNew}}
            <li>
              <a href="#" id="show-create">
                <span class="glyphicon glyphicon-plus"></span> Create new row</a></li>
          {{/unless}}
          <li>
            <a href="#" id="reorderRows">
              <span class="glyphicon glyphicon-align-justify"></span> Reorder rows</a></li>
        {{/if}}
        <li>
          <a href="{{pathFor 'referencesMain' monographAgent=getMonographAgent}}">
            <span class="fa fa-book"></span> View references</a></li>
        <li> {{> optFullScreen}} </li>
        <li>
          <a href="#" id="downloadExcel">
            <span class="fa fa-file-excel-o"></span> Download Excel</a></li>
        <li>
          <a href="#" id="wordReport">
            <span class="fa fa-file-word-o"></span> Download Word</a></li>
        <li>
          <a href="#" id="toggleShowAllRows">
            {{#if isShowAll}}<span class="glyphicon glyphicon-resize-small"></span> Hide rows
            {{else}}<span class="glyphicon glyphicon-resize-full"></span> Show all rows
            {{/if}}</a></li>
        <li>
          <a href="#" id="toggleQAflags">
            <span class="fa fa-flag-o"></span> Toggle QA flags</a></li>
      </ul>
    </div>
  </h1>
  {{> tableTitle}}

  <table class="evidenceTable table table-compressed">
    <colgroup>
      <col width="15%">
      <col width="20%">
      <col width="15%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="20%">
    </colgroup>
    <thead>
      <tr>
        <th>Reference</th>
        <th>Test system</th>
        <th>Endpoint test</th>
        <th>Results</th>
        <th>Results<br>(with metabolic activation)</th>
        <th>Agent,<br>LED/HID dose</th>
        <th>Comments</th>
      </tr>
    </thead>
    <tbody id="sortable">
      {{#each object_list}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
              data-id="{{_id}}"
              data-sortIdx="{{sortIdx}}">
            {{#if isEditing}}
              <td id="editingRow" colspan="100">
                {{> genotoxForm this isNew=false}}
              </td>
            {{else}}
              {{> genotoxRow}}
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No data has been entered into this table.</td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{#if userCanEdit}}
    {{#unless showNew}}<br><br>
    <a href="#" class="btn btn-primary btn-sm" id="show-create">
      <span class="glyphicon glyphicon-plus"></span> Create new row</a>
    {{/unless}}
  {{/if}}

  {{#if showNew}}
    {{> genotoxForm isNew=true}}
  {{/if}}

  <div id="modalHolder"></div>

</template>


<template name='genotoxRow'>
  <td>
    {{#if userCanEdit}}
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
          <span class="caret" title="Editing options"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#" id="clone-content">
              <span class="fa fa-copy"></span> Create a clone</a></li>
          <li>
            <a href="#" id="move-content">
              <span class="fa fa-arrow-circle-right"></span> Move to a different table</a></li>
          <li>
              <a href="#" id="toggle-hidden">{{#if isHidden}}
                <span class="glyphicon glyphicon-plus"></span> Show row
                {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{qaMark isQA}}
    {{>printReference id=referenceID}}<br>
    {{{getCol1}}}
  </td>
  <td>
    {{{getCol2}}}
  </td>
  <td>
    {{{getCol3}}}
  </td>
  <td>
    {{{getCol4}}}
  </td>
  <td>
    {{{getCol5}}}
  </td>
  <td>
    {{{getCol6}}}
  </td>
  <td>
    {{{getCol7}}}
  </td>
  <td class="dragHandle dhOuter" style="display: none" title="Drag to re-order rows"></td>
</template>


<template name="genotoxForm">
  <form id="mainForm" role="form" class="editForm">
    <legend>Genotoxicity evidence {{>formLegendPulldown}}</legend>
    <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.</p>

    <!-- First row. Reference, data-type, and agent -->
    <div class="form-group row">

      <div class="col-xs-4">
        {{> referenceSingleSelect}}
      </div>

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Data class*</label>
        {{> selectList options=getDataClass selected=dataClass selectName="dataClass" }}
      </div>

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Agent*</label>
        {{> typeaheadInput name="agent" value=agent methodName="searchGenotoxAgents" placeholder="Trichloroethylene"}}
      </div>

    </div>

    <!-- Second row. Test-system description. -->
    <div class="form-group row">

      <div class="col-xs-3 non_mamm">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Phylogenetic class*</label>
        {{> selectList options=getPhylogeneticClasses selected=phylogeneticClass selectName="phylogeneticClass" }}
      </div>

      <div class="col-xs-3 non_mamm isAcellular">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Test system*</label>
        {{> typeaheadInput name="testSystem" value=testSystem methodName="searchGenotoxTestSystem" placeholder="Calf thymus DNA"}}
      </div>

      <div class="col-xs-3 non_mamm isntAcellular">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Species*</label>
        {{> typeaheadInput name="speciesNonMamm" value=speciesNonMamm methodName="searchSpeciesNonMamm" placeholder="Salmonella typhimurium"}}
      </div>

      <div class="col-xs-3 non_mamm isntAcellular">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Strain*</label>
        {{> typeaheadInput name="strainNonMamm" value=strainNonMamm methodName="searchStrainNonMamm" placeholder="TA98"}}
      </div>

      <div class="col-xs-3 mamm_vitro">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Test species*</label>
        {{> selectList options=getMammalianTestSpecies selected=testSpeciesMamm selectName="testSpeciesMamm" }}
      </div>

      <div class="col-xs-3 mamm_vitro">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Species*</label>
        {{> typeaheadInput name="speciesMamm" value=speciesMamm methodName="searchSpeciesMamm" placeholder="Human"}}
      </div>

      <div class="col-xs-3 mamm_vitro">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Tissue, cell line*</label>
        {{> typeaheadInput name="tissueCellLine" value=tissueCellLine methodName="searchTissueCellLine" placeholder="Liver/HepG2"}}
      </div>

      <div class="col-xs-3 ani_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Species*</label>
        {{> typeaheadInput name="species" value=species methodName="searchGenotoxSpecies" placeholder="Mouse"}}
      </div>

      <div class="col-xs-3 ani_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="If no strain specified, add common name in parentheses">
              Strain*</label>
        {{> typeaheadInput name="strain" value=strain methodName="searchGenotoxStrain" placeholder="B6C3F1"}}
      </div>

      <div class="col-xs-3 ani_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Sex*</label>
        {{> selectList options=getSexes selected=sex selectName="sex" }}
      </div>

      <div class="col-xs-3 ani_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Tissue*</label>
        {{> typeaheadInput name="tissueAnimal" value=tissueAnimal methodName="searchGenotoxTissueAnimal" placeholder="bone marrow"}}
      </div>

      <div class="col-xs-3 human_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Tissue*</label>
        {{> typeaheadInput name="tissueHuman" value=tissueHuman methodName="searchGenotoxTissueHuman" placeholder="skin"}}
      </div>

      <div class="col-xs-3 human_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Cell type (if specified)</label>
        {{> typeaheadInput name="cellType" value=cellType methodName="searchGenotoxCellType" placeholder="endothelial"}}
      </div>

      <div class="col-xs-6 human_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Description of exposed and controls*</label>
        <input class="form-control" type="text"
               name='exposureDescription'
               value="{{exposureDescription}}"
               placeholder="Farmers; 123,000; Australia"/>
      </div>

    </div>

    <!-- Third row. Test class. -->
    <div class="form-group row">

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Endpoint*</label>
        <select class="form-control" name='endpoint' value="{{endpoint}}"></select>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Endpoint test*</label>
        <select class="form-control" name='endpointTest' value="{{endpointTest}}"></select>
      </div>

      <div class="col-xs-2 ani_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Route*</label>
        {{> typeaheadInput name="dosingRoute" value=dosingRoute methodName="searchGenotoxDosingRoute" placeholder="Drinking water"}}
      </div>

      <div class="col-xs-2 vitro">
        <label class="helpPopovers" data-toggle="popover"
            data-content="Check if two-results are available: with and without exogenous metabolic activation">
            Metabolic activation tested?</label>
        <div class="checkbox">
          <input style="{margin-left: 10px}"
                 type="checkbox" name='dualResult'
                 checked="{{dualResult}}"/>
        </div>
      </div>

      <div class="col-xs-2 expvivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Duration*</label>
        <input class="form-control" type="text"
               name='dosingDuration'
               value="{{dosingDuration}}"
               placeholder="28 day"/>
      </div>

      <div class="col-xs-2 ani_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              Dosing regimen*</label>
        <input class="form-control" type="text"
               name='dosingRegimen'
               value="{{dosingRegimen}}"
               placeholder="2 week; 1x/week"/>
      </div>

    </div>

    <!-- Fourth row. Results. -->
    <div class="form-group row">

      <div class="isntDualResult col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="
                <strong>Working Group judgment:</strong>
                <ul>
                <li>+, positive</li>
                <li>–, negative</li>
                <li>+/–, equivocal (variable response in several experiments
                    within an adequate study)</li>
                 <li>(+) or (–), positive/negative in a study of limited quality
                      (specify reason in comments, e.g. only a singe dose tested;
                      data or methods not fully reported; confounding exposures, etc.)</li>
                 </ul>
              ">
              <br>Result*</label>
        {{> selectList options=getResultOptions selected=result selectName="result" }}
      </div>

      <div class="isDualResult col-xs-3">
        <label class=" helpPopovers" data-toggle="popover"
              data-content="
                <strong>Working Group judgment:</strong>
                <ul>
                <li>+, positive</li>
                <li>–, negative</li>
                <li>+/–, equivocal (variable response in several experiments
                    within an adequate study)</li>
                 <li>(+) or (–), positive/negative in a study of limited quality
                      (specify reason in comments, e.g. only a singe dose tested;
                      data or methods not fully reported; confounding exposures, etc.)</li>
                 </ul>
              ">
              Result*<br>(with metabolic activation)</label>
        {{> selectList options=getResultOptions selected=resultMetabolic selectName="resultMetabolic" }}
      </div>

      <div class="col-xs-3 isDualResult">
        <label class="helpPopovers" data-toggle="popover"
              data-content="
                <strong>Working Group judgment:</strong>
                <ul>
                <li>+, positive</li>
                <li>–, negative</li>
                <li>+/–, equivocal (variable response in several experiments
                    within an adequate study)</li>
                 <li>(+) or (–), positive/negative in a study of limited quality
                      (specify reason in comments, e.g. only a singe dose tested;
                      data or methods not fully reported; confounding exposures, etc.)</li>
                 </ul>
              ">
              Result*<br>(without metabolic activation)</label>
        {{> selectList options=getResultOptions selected=resultNoMetabolic selectName="resultNoMetabolic" }}
      </div>

      <div class="col-xs-3">
        <label class="doses helpPopovers" data-toggle="popover"
              data-content="As reported">
              <br>LED or HID</label>
        <label class="concs helpPopovers" data-toggle="popover"
              data-content="As reported">
              <br>LEC or HIC</label>
        <input class="form-control" type="text"
               name="led"
               value="{{led}}"
               placeholder="100"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              <br>Dosing units*</label>
        {{> typeaheadInput name="units" value=units methodName="searchGenotoxDosingUnits" placeholder="μM"}}
      </div>

      <div class="col-xs-3 expvivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              <br>Doses tested*</label>
        <input class="form-control" type="text"
               name='dosesTested'
               value="{{dosesTested}}"
               placeholder="0, 3, 10, 30"/>
      </div>

      <div class="col-xs-3 human_vivo">
        <label class="helpPopovers" data-toggle="popover"
              data-content="As reported">
              <br>Significance</label>
        <input class="form-control" type="text"
               name='significance'
               value="{{significance}}"
               placeholder="p<0.05"/>
      </div>

    </div>

    <!-- Fifth row. Comments. -->
    <div class="form-group row">

      <div class="col-xs-12">
        <label class="helpPopovers" data-toggle="popover"
               data-content="Other relevant information or working-group comments.
                             For human in-vivo data, this may include any
                             co-exposures, strengths, limitations, or extent to
                             which chance, bias, or confounding could explain the results.">
              Comments</label>
        <textarea class="form-control" type="text"
                  rows="3" name="comments">{{comments}}</textarea>
      </div>

    </div>


    <div id="errors"></div>

    <!-- QA notice -->
    {{#if isQA }}
      <strong>{{QAstampFormat timestampQA user_id_QA}}</strong>
    {{/if}}

    <!-- Submission -->
    <div class="well well-sm pager">
      {{#if isNew }}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="create"
                title="Save new">
                <span class="glyphicon glyphicon-ok"></span> Create</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="create-cancel"
                title="Cancel">Cancel</button>
      {{else}}
        {{#if isQA }}
          <button type="button"
                  class="btn btn-sm btn-default"
                  id="update-cancel"
                  title="Cancel changes">Close</button>
          {{#if isInRole 'staff'}}
            <button type ="button"
                      id   ="unsetQA"
                      class="pull-right btn btn-sm btn-warning"
                      title="Unset data as QA'd and allow further changes">
                      <span class="fa fa-exclamation-circle"></span> Remove QA'd</button>
          {{/if}}
        {{else}}
          <button type="button"
                  class="btn btn-sm btn-primary"
                  id="update"
                  title="Save changes">
                  <span class="glyphicon glyphicon-ok"></span> Save</button>
          <button type="button"
                  class="btn btn-sm btn-default"
                  id="update-cancel"
                  title="Cancel changes">Cancel</button>
          <button type="button"
                  class="btn btn-sm btn-danger"
                  id="delete" title="Delete row">
                  <span class="glyphicon glyphicon-trash"></span></button>
          {{#if isInRole 'staff'}}
            <button type ="button"
                    id   ="setQA"
                    class="pull-right btn btn-sm btn-success"
                    title="Make data as QA'd and prevent further changes">
                    <span class="fa fa-check-circle"></span> Mark QA'd</button>
          {{/if}}
        {{/if}}
      {{/if}}
    </div>
  </form>
  <!-- Add input form-modals outside form scope -->
  {{> referenceQuickAddModal}}
</template>
