<template name="home">
  <div class="container">
  {{#if currentUser}}
      {{> TablesByMonograph}}
    {{else }}
      <div class="row">
        <div class="col-md-offset-3 col-md-6">
          <h1>Welcome!</h1>
          <p>This application is designed for monograph sections to collaborate on
             assembling key evidence which will be useful in the development of the
             IARC monographs. If a user is given permission to edit the data for a
             specific assessment, after logging-in, key evidence tables will be
             available.</p>
          <p><strong>Access is controlled; you'll need to login in order to view or edit documents.</strong></p>
          {{# if hasContactEmail}}
            <p>For technical help, please <a target="_blank" href="mailto:{{contactEmail}}">contact us</a>.</p>
          {{/if}}
      </div>
      </div>
    {{/if}}
  </div>
</template>

<template name="TablesByMonograph">
  <div class="row">
    <div class="col-md-offset-1 col-md-10">
      <h1>Available evidence streams
          {{#if isInRole 'staff'}}
          <div class="btn-group pull-right">
            <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
              Actions <span class="caret" title="Editing options"></span>
            </button>
            <ul class="dropdown-menu">
              {{#unless showNew}}
                <li>
                  <a href="#" id="tables-show-create">
                    <span class="glyphicon glyphicon-plus"></span> New</a></li>
              {{/unless}}
              <li>
                <a href="#" id="reorderRows">
                  <span class="glyphicon glyphicon-align-justify"></span> Reorder rows</a></li>
            </ul>
          </div>
        {{/if}}
      </h1>

      {{#unless showNew}}
        {{#each getMonographs}}
          <div class="monographBanner">
            <h2>Volume {{this}}</h2>
          </div>
         {{#each getMonographAgents this}}
          <div class="agentBanner">
            <h3 class= "menu-autohide">{{this}}
              <div class="rowOptions btn-group pull-right">
                <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
                  <span class="caret" title="Editing options"></span>
                </button>
                <ul class="dropdown-menu">
                    <li>
                      <a href="{{pathFor 'referencesMain' monographAgent=this}}">
                        <span class="glyphicon glyphicon-edit"></span> View references</a></li>
                    <li>
                      <a href="#" id="agentEpiReport" data-volumeNumber="{{..}}" data-monographAgent="{{this}}">
                        <span class="fa fa-file-word-o"></span> Download epidemiological report</a></li>
                </ul>
              </div>
            </h3>
          </div>
          <div class="sortables">
            {{#each getTables .. . }}
              {{#if isEditing}}
                {{> tablesForm}}
              {{else}}
                <div class="moveTableHolder"
                     data-id="{{_id}}"
                     data-sortIdx="{{sortIdx}}">
                  <span class="moveTableHandle" style="display: none" title="Drag to re-order rows"></span>
                  <a class="noUnderline" href="{{getURL}}">
                    <div class="tableDiv menu-autohide">
                      <span class="label label-default">{{tblType}} </span>
                      {{#if canEdit}}
                        <div class="rowOptions btn-group pull-right">
                          <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
                            <span class="caret" title="Editing options"></span>
                          </button>
                          <ul class="dropdown-menu">
                              <li><a href="#" id="tables-show-edit"><span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                          </ul>
                        </div>
                      {{/if}}
                      <br>{{name}}
                    </div>
                  </a>
                </div>
              {{/if}}
            {{/each}}
          </div>
         {{/each}}
        {{else}}
          <p>You don't have access to any evidence tables.
             You must be `staff` to create a new evidence table.</p>
        {{/each}}
      {{else}}
        <h2>Create a new evidence table</h2>
        {{> tablesForm}}
      {{/unless}}
    </div>
  </div>
  <div id="modalHolder"></div>
</template>

<template name="tablesForm">
  <form id="tablesForm" role="form" class="editForm">

    <p class="help-block">Fields marked with an asterisk (<b>*</b>) are required.</p>

    <div class="form-group row">
      <div class="col-xs-3">
        <label>Volume Number*</label>
        <input class="form-control" name='volumeNumber' type="number" value="{{volumeNumber}}"/>
      </div>
      <div class="col-xs-5">
        <label>Monograph Agent Name*</label>
        {{> typeaheadInput name="monographAgent" value=monographAgent methodName="searchMonographAgent"}}
      </div>
      <div class="col-xs-4">
        <label>Table Type*</label>
        {{> selectList options=getTblTypeOptions selected=tblType selectName="tblType" }}
      </div>
    </div>
    <div class="form-group">
      <label>Table Name*</label>
      <input class="form-control" name='name' type="text" value="{{name}}"/>
    </div>
    <div class="form-group row">
      <div class="col-xs-4">
        <label>Project managers</label>
        <input class="form-control typeahead userTypeahead" name='projectManagers'
               type="text" autocomplete="off" data-source="searchUsers"
               data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can change permissions for who has access.</p>
        <ul class="projectManagers">
          {{#each getRoledUsers 'projectManagers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
      <div class="col-xs-4">
        <label>Team members</label>
        <input class="form-control typeahead userTypeahead" name='teamMembers'
               type="text" autocomplete="off" data-source="searchUsers"
               data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can create/change/delete content for a selected table.</p>
        <ul class="teamMembers">
          {{#each getRoledUsers 'teamMembers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
      <div class="col-xs-4">
        <label>Reviewers</label>
        <input class="form-control typeahead userTypeahead" name='reviewers' type="text"
               autocomplete="off" data-source="searchUsers"
               data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can view but not change content.</p>
        <ul class="reviewers">
          {{#each getRoledUsers 'reviewers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
    </div>

    <div id="errors"></div>

    <div class="well well-sm pager">
      {{#if _id}}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="tables-update"
                title="Save changes">
          <span class="glyphicon glyphicon-ok"></span> Save</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="tables-update-cancel"
                title="Cancel changes">Cancel</button>
        <button type="button"
                class="btn btn-sm btn-danger"
                id="tables-delete"
                title="Delete row">
          <span class="glyphicon glyphicon-trash"></span></button>
      {{else}}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="tables-create"
                title="Save new">
          <span class="glyphicon glyphicon-ok"></span> Create</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="tables-create-cancel"
                title="Cancel">Cancel</button>
      {{/if}}
    </div>
  </form>
</template>

<template name="UserMatchPullDown">
  <p>{{getUserDescription}}</p>
</template>

<template name="UserLI">
  <li class='selectListItem' data-user_id='{{_id}}'>{{getUserDescription}}
    <a href='#' class='pull-right removeUser btn btn-default btn-xs' title='Remove from list'>
      <span class='glyphicon glyphicon-remove'></span>
    </a>
  </li>
</template>
