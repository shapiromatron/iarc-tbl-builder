<template name="home">
  <div class="container">
  {{#if currentUser}}
      {{> tablesTbl }}
    {{else }}
      <h1>Welcome to the IARC table builder</h1>
      <p>This application is designed to store and display key data used in the IARC monograph assessments. Groups of users can collaboratively work together to build evidence tables from multiple streams of evidence.</p>
      <p>Access is controlled; you'll need to login in order to view or edit documents.</p>
    {{/if}}
  </div>
</template>

<template name="tablesTbl">
  <h1>Tables which I have access to.
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#unless showNew}}
          <li><a href="#" id="tables-show-create"><span class="glyphicon glyphicon-plus"></span> New</a></li>
        {{/unless}}
      </ul>
    </div>
  </h1>

  <table class="table table-compressed table-striped">
    <colgroup>
      <col width="20%">
      <col width="40%">
      <col width="20%">
      <col width="20%">
    </colgroup>
    <thead>
      <tr>
        <th>Monograph &amp; Agent</th>
        <th>Name</th>
        <th>Type</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody>
      {{#each getTables}}
        <tr class="menu-autohide">
          {{#if isEditing}}
            <td id="editingRow" colspan="100">
              {{> tablesForm}}
            </td>
          {{else}}
            <td>{{monographNumber}}: {{agent}}
                {{#if canEdit}}
                  <div class="rowOptions btn-group pull-right">
                    <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
                      <span class="caret" title="Editing options"></span>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#" id="tables-show-edit"><span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                    </ul>
                  </div>
                {{/if}}
            </td>
            <td><a href="{{getURL}}">{{name}}</a></td>
            <td>{{tblType}}</td>
            <td>{{formatDate timestamp "long"}}</td>
          {{/if}}
        </tr>
      {{else}}
        {{#unless showNew}}
          <tr>
            <td colspan="100">You haven't created any tables yet.<br><br>
              <a href="#" class="btn btn-primary btn-sm" id="tables-show-create"><span class="glyphicon glyphicon-plus"></span> Create new</a>
            </td>
          </tr>
        {{/unless}}
      {{/each}}
    </tbody>
  </table>

  {{#if showNew}}
    {{> tablesForm}}
  {{/if}}
</template>

<template name="tablesForm">
  <form id="tablesForm" role="form" class="editForm">
    <div class="form-group row">
      <div class="col-xs-2">
        <label>Monograph Number</label>
        <input class="form-control" name='monographNumber' type="number" value="{{monographNumber}}"/>
      </div>
      <div class="col-xs-5">
        <label>Agent Name</label>
        {{> typeaheadInput name="agent" value=agent data_source="searchAgent"}}
      </div>
      <div class="col-xs-5">
        <label>Table Type</label>
        {{> selectList options=getTblTypeOptions selected=tblType selectName="tblType" }}
      </div>
    </div>
    <div class="form-group">
      <label>Table Name</label>
      <input class="form-control" name='name' type="text" value="{{name}}"/>
    </div>
    <div class="form-group row">
      <div class="col-xs-4">
        <label>Project managers</label>
        <input class="form-control typeahead" name='projectManagers'
               type="text" autocomplete="off" data-source="searchUsers"
               data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can change permissions for who has access.</p>
        <ul class="projectManagers">
          {{#each getRoledUsers 'projectManagers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
      <div class="col-xs-4">
        <label>Team members</label>
        <input class="form-control typeahead" name='teamMembers'
               type="text" autocomplete="off" data-source="searchUsers"
               data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can create/change/delete content for a selected table.</p>
        <ul class="teamMembers">
          {{#each getRoledUsers 'teamMembers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
      <div class="col-xs-4">
        <label>Reviewers</label>
        <input class="form-control typeahead" name='reviewers' type="text"
               autocomplete="off" data-source="searchUsers"
               data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can view but not change content.</p>
        <ul class="reviewers">
          {{#each getRoledUsers 'reviewers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
    </div>
    <div class="well well-sm pager">
      {{#if _id}}
        <button type="button" class="btn btn-sm btn-primary" id="tables-update" title="Save changes"><span class="glyphicon glyphicon-ok"></span> Save</button>
        <button type="button" class="btn btn-sm btn-default" id="tables-update-cancel" title="Cancel changes">Cancel</button>
        <button type="button" class="btn btn-sm btn-danger"  id="tables-delete" title="Delete row"><span class="glyphicon glyphicon-trash"></span></button>
      {{else}}
        <button type="button" class="btn btn-sm btn-primary" id="tables-create" title="Save new"><span class="glyphicon glyphicon-ok"> Create</span></button>
        <button type="button" class="btn btn-sm btn-default" id="tables-create-cancel" title="Cancel">Cancel</button>
      {{/if}}
    </div>
  </form>
</template>


<template name="UserMatchPullDown">
  <p>{{getUserDescription}}</p>
</template>


<template name="UserLI">
  <li class='selectListItem' data-user_id='{{_id}}'>{{getUserDescription}}
    <a href='#' class='pull-right removeUser btn btn-default btn-xs' title='Remove from list'>
      <span class='glyphicon glyphicon-remove'></span>
    </a>
  </li>
</template>
