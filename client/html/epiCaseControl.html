<template name="epiCaseControlMain">
  <div class="container">
    {{> epiCaseControlTbl}}
  </div>
</template>

<template name="epiCaseControlTbl">
  <h1>{{name}}
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#if userCanEdit}}
          {{#unless epiCaseControlShowNew}}
            <li><a href="#" id="epiCaseControl-show-create"><span class="glyphicon glyphicon-plus"></span> Create new row</a></li>
          {{/unless}}
        {{/if}}
        <li><a href="#" id="epiCaseControl-downloadExcel"><span class="glyphicon glyphicon-save"></span> Download Excel</a></li>

        <li><a href="#" id="epiCaseControl-epiRiskShowPlots">
          {{#if showPlots}}<span class="glyphicon glyphicon-eye-close"></span> Hide risk plots
          {{else}}<span class="glyphicon glyphicon-eye-open"></span> Show risk plots
          {{/if}}</a>
        </li>

        <li><a href="#" id="epiCaseControl-toggleShowAllRows">
          {{#if isShowAll}}<span class="glyphicon glyphicon-resize-small"></span> Hide rows
          {{else}}<span class="glyphicon glyphicon-resize-full"></span> Show all rows
          {{/if}}</a>
        </li>
      </ul>
    </div>
  </h1>

  <table class="table table-compressed">
    <colgroup>
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="10%">
      <col width="20%">
    </colgroup>
    <thead>
      <tr>
        <th>Reference,<br>study location,<br>and period</th>
        <th>Total cases<br>Total controls</th>
        <th>Control source<br>(hospital, population)</th>
        <th>Exposure Assessment</th>
        <th>Organ site<br>(ICD code)</th>
        <th>Exposure<br>categories</th>
        <th>Exposed<br>cases</th>
        <th class="riskTR">Relative risk<br>(95% CI)</th>
        <th>Covariates<br>Comments</th>
      </tr>
    </thead>
    <tbody>
      {{#each getEpiCaseControls}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}" data-id="{{_id}}" data-sortIdx="{{sortIdx}}">
            {{#if epiCaseControlIsEditing}}
              <td id="editingRow" colspan="100">
                {{> epiCaseControlForm this epiCaseControlNew="F"}}
              </td>
            {{else}}
              <td>
                {{#if userCanEdit}}
                  <div class="rowOptions btn-group pull-right">
                    <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
                      <span class="caret" title="Editing options"></span>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a href="#" id="epiCaseControl-show-edit"><span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                      <li><a href="#" id="epiCaseControl-move-up"><span class="glyphicon glyphicon-arrow-up"></span> Move up</a></li>
                      <li><a href="#" id="epiCaseControl-move-down"><span class="glyphicon glyphicon-arrow-down"></span> Move down</a></li>
                      <li><a href="#" id="epiCaseControl-toggle-hidden">{{#if isHidden}}
                        <span class="glyphicon glyphicon-plus"></span> Show row
                        {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                        {{/if}}</a>
                      </li>
                      <li><a href="#" id="epiCaseControl-copy-as-new"><span class="glyphicon glyphicon-repeat"></span> Copy as new</a></li>
                    </ul>
                  </div>
                {{/if}}
                {{{printReference id=referenceID}}}<br>{{location}}<br>{{followUpPeriod}}
              </td>
              <td><span>{{numCases}} {{numCasesText}}<br>{{numControls}} {{numControlsText}}</span></td>
              <td>{{controlSource}}</td>
              <td>{{exposureAssessment}}</td>
              <td colspan="4">
                {{> epiRiskEstimateTbl parent=this epiRiskEstimateEditable="F" }}
              </td>
              <td>{{covariates}}<br>{{comments}}</td>
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No case-controls have been created.
            {{#unless epiCaseControlShowNew}}<br><br>
              <a href="#" class="btn btn-primary btn-sm" id="epiCaseControl-show-create"><span class="glyphicon glyphicon-plus"></span> Create new row</a>
            {{/unless}}
          </td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{ drawRiskPlotAxis }}

  {{#if epiCaseControlShowNew}}
    {{> epiCaseControlForm epiCaseControlNew="T"}}
  {{/if}}
</template>

<template name="epiCaseControlForm">
  <form id="epiCaseControlForm" role="form" class="editForm">
    <div class="form-group row">
      <div class="col-xs-4">
        <label>Reference</label>
        {{> referenceSelector}}
      </div>
      <div class="col-xs-4">
        <label>Cohort Location</label>
        <input class="form-control" name='location' type="text" value="{{location}}"/>
      </div>
      <div class="col-xs-4">
        <label>Follow-up period</label>
        <input class="form-control" name='followUpPeriod' type="text" value="{{followUpPeriod}}"/>
      </div>
    </div>
    <div class="form-group row">
      <div class="col-xs-4">
        <label>Total cases</label>
        <input class="form-control" name='numCases' type="number" value="{{numCases}}" placeholder="Numeric" />
        <br>
        <label>Total controls</label>
        <input class="form-control" name='numControls' type="number" value="{{numControls}}" placeholder="Numeric" />
      </div>
      <div class="col-xs-4">
        <label>Total cases (text-details)</label>
        <input class="form-control" name='numCasesText' type="text" value="{{numCasesText}}"/>
        <br>
        <label>Total controls (text-details)</label>
        <input class="form-control" name='numControlsText' type="text" value="{{numControlsText}}"/>
      </div>
      <div class="col-xs-4">
        <label>Control source (hospital, population)</label>
        <textarea class="form-control" name='controlSource' rows="3">{{controlSource}}</textarea>
      </div>
    </div>
    <div class="form-group row">
      <div class="col-xs-4">
        <label>Exposure assessment details</label>
        <textarea class="form-control" name='exposureAssessment' rows="3">{{exposureAssessment}}</textarea>
      </div>
      <div class="col-xs-4">
        <label>Covariates</label>
        <textarea class="form-control" name='covariates' rows="3">{{covariates}}</textarea>
      </div>
      <div class="col-xs-4">
        <label>Comments</label>
        <textarea class="form-control" name='comments' rows="3">{{comments}}</textarea>
      </div>
    </div>

    <div class="well well-sm pager">
      {{#if epiCaseControlIsNew epiCaseControlNew }}
        <button type="button" class="btn btn-sm btn-primary" id="epiCaseControl-create" title="Create new"><span class="glyphicon glyphicon-ok"></span> Create</button>
        <button type="button" class="btn btn-sm btn-default" id="epiCaseControl-create-cancel" title="Cancel">Cancel</button>
      {{else}}
        <button type="button" class="btn btn-sm btn-primary" id="epiCaseControl-update" title="Save changes"><span class="glyphicon glyphicon-ok"> Save</span></button>
        <button type="button" class="btn btn-sm btn-default" id="epiCaseControl-update-cancel" title="Cancel changes">Cancel</button>
        <button type="button" class="btn btn-sm btn-danger"  id="epiCaseControl-delete" title="Delete row"><span class="glyphicon glyphicon-trash"></span></button>
      {{/if}}
    </div>
  </form>

  {{#unless epiCaseControlIsNew epiCaseControlNew }}
    {{> epiRiskEstimateTbl parent=this epiRiskEstimateEditable="T"}}
  {{/unless}}
</template>
