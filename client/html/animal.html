<template name="animalMain">
  {{#if Template.subscriptionsReady}}
    <div class="{{getContainerClass}}">
      {{> animalTbl}}
    </div>
  {{else}}
    {{> isLoading}}
  {{/if }}
</template>


<template name="animalTbl">
  <h1>{{name}}
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        Actions <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#if userCanEdit}}
          {{#unless showNew}}
            <li>
              <a href="#" id="show-create">
                <span class="glyphicon glyphicon-plus"></span> Create new row</a></li>
          {{/unless}}
          <li>
            <a href="#" id="reorderRows">
              <span class="glyphicon glyphicon-align-justify"></span> Reorder rows</a></li>
        {{/if}}
        <li>
          <a href="{{pathFor 'referencesMain' monographAgent=getMonographAgent}}">
            <span class="fa fa-book"></span> View references</a></li>
        <li> {{> optFullScreen}} </li>
        <li>
          <a href="#" id="downloadExcel">
            <span class="fa fa-file-excel-o"></span> Download Excel</a></li>
        {{#each getReportTypes}}
          <li>
            <a href="#" class="wordReport" data-type="{{type}}" data-fn="{{fn}}">
              <span class="fa fa-file-word-o"></span> {{text}}</a></li>
        {{else}}
          <li>
            <a href="#" id="wordReport">
              <span class="fa fa-file-word-o"></span> Download Word</a></li>
        {{/each}}
        <li>
          <a href="#" id="toggleShowAllRows">
            {{#if isShowAll}}<span class="glyphicon glyphicon-resize-small"></span> Hide rows
            {{else}}<span class="glyphicon glyphicon-resize-full"></span> Show all rows
            {{/if}}</a></li>
        <li>
          <a href="#" id="toggleQAflags">
            <span class="fa fa-flag-o"></span> Toggle QA flags</a></li>
      </ul>
    </div>
  </h1>
  {{> tableTitle}}

  <table class="evidenceTable table table-compressed">
    <colgroup>
      <col width="15%">
      <col width="20%">
      <col width="26%">
      <col width="14%">
      <col width="25%">
    </colgroup>
    <thead>
      <tr>
        <th>
          Study design<br>
          Species, strain (sex)<br>
          Age at start<br>
          Duration<br>
          Reference</th>

        <th>
          Route<br>
          Agent tested, purity<br>
          Vehicle<br>
          Dose(s)<br>
          # animals at start<br>
          # surviving animals</th>

        <th>
          Results</th>
        <th>
          Significance</th>
        <th>
          Comments</th>
      </tr>
    </thead>
    <tbody id="sortable">
      {{#each object_list}}
        {{#if showRow isHidden}}
          <tr class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
              data-id="{{_id}}"
              data-sortIdx="{{sortIdx}}">
            {{#if isEditing}}
              <td id="editingRow" colspan="100">
                {{> animalForm this isNew=false}}
              </td>
            {{else}}
              {{> animalRow}}
            {{/if}}
          </tr>
        {{/if}}
      {{else}}
        <tr>
          <td colspan="100">No data has been entered into this table.</td>
        </tr>
      {{/each}}
    </tbody>
  </table>

  {{#if userCanEdit}}
    {{#unless showNew}}<br><br>
    <a href="#" class="btn btn-primary btn-sm" id="show-create">
      <span class="glyphicon glyphicon-plus"></span> Create new row</a>
    {{/unless}}
  {{/if}}

  {{#if showNew}}
    {{> animalForm isNew=true}}
  {{/if}}

  <div id="modalHolder"></div>
</template>


<template name='animalRow'>
  <td>
    {{#if userCanEdit}}
      <div id="nestedModalHolder"></div>
      <div class="rowOptions btn-group pull-right">
        <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
          <span class="caret" title="Editing options"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a href="#" id="show-edit">
              <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
          <li>
            <a href="#"
               class="add-nested"
               title="Display modal for entering results">
              <span class="fa fa-medkit"></span> Add results</a></li>
          <li>
            <a href="#" id="clone-content">
              <span class="fa fa-copy"></span> Create a clone</a></li>
          <li>
            <a href="#" id="move-content">
              <span class="fa fa-arrow-circle-right"></span> Move to a different table</a></li>
          <li>
              <a href="#" id="toggle-hidden">{{#if isHidden}}
                <span class="glyphicon glyphicon-plus"></span> Show row
                {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                {{/if}}</a></li>
        </ul>
      </div>
    {{/if}}
    {{qaMark isQA}}
    <strong>{{studyDesign}}</strong><br>
    <strong>{{species}}</strong>, {{strain}} ({{sex}})<br>
    {{ageAtStart}}<br>
    {{duration}}<br>
    {{>printReference id=referenceID}}</td>

  <td>
    {{dosingRoute}}<br>
    {{agent}}, {{purity}}<br>
    {{vehicle}}<br>
    {{getDoses}}<br>
    {{dosingRegimen}}<br>
    {{getNStarts}}<br>
    {{getNSurvivings}}</td>

  <td id="sortableInner" colspan="2">
    {{#each getChildren}}
      {{> animalEndpointTbl}}
    {{else}}
      <p class="help-block">No endpoints have been created.
        {{#if userCanEdit}}
          <br><a href="#"
             class="btn btn-primary btn-sm add-nested"
             title="Display modal for entering endpoints">
            <span class="fa fa-medkit"></span> Add endpoint</a>
        {{/if}}
      </p>
    {{/each }}</td>

  <td>
    <strong>Principal strengths:</strong>{{> listOrNone list=strengths}}
    <strong>Principal limitations:</strong>{{> listOrNone list=limitations}}
    <strong>Other comments:</strong><br>{{comments}}</td>

  <td class="dragHandle dhOuter" style="display: none" title="Drag to re-order rows"></td>
</template>


<template name="listOrNone">
  <br>
  {{# if list}}
    <ul>
      {{#each list}}
        <li>{{this}}</li>
      {{/each}}
    </ul>
  {{else}}
    <p><i>None</i></p>
  {{/if}}
</template>


<template name="animalForm">
  <form id="mainForm" role="form" class="editForm">
    <legend>Animal bioassay evidence {{>formLegendPulldown}}</legend>
    <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.</p>

    <!-- First row -->
    <div class="form-group row">

      <div class="col-xs-3">
        {{> referenceSingleSelect}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Data class*</label>
        {{> selectList options=getStudyDesigns selected=studyDesign selectName="studyDesign" }}
      </div>

      <div class="col-xs-2">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Species*</label>
        {{> typeaheadInput name="species" value=species methodName="searchAnimalSpecies" placeholder="Mouse, Rat, Hamster"}}
      </div>

      <div class="col-xs-2">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Strain*</label>
        {{> typeaheadInput name="strain" value=strain methodName="searchAnimalStrain" placeholder="B6C3F1, F344"}}
      </div>

      <div class="col-xs-2">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Sex*</label>
        {{> selectList options=getSexes selected=sex selectName="sex" }}
      </div>

    </div>


    <!-- Second row. Agent tested. -->
    <div class="form-group row">

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Agent tested*</label>
        {{> typeaheadInput name="agent" value=agent methodName="searchAnimalAgent" placeholder="Trichloroethylene, Asbestos"}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Purity*</label>
        {{> typeaheadInput name="purity" value=purity methodName="searchAnimalPurity" placeholder=">99.9%, technical grade"}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Route*</label>
        {{> typeaheadInput name="dosingRoute" value=dosingRoute methodName="searchAnimalDosingRoute" placeholder="Gavage, feed, i.p."}}
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Vehicle*</label>
        {{> typeaheadInput name="vehicle" value=vehicle methodName="searchAnimalVehicle" placeholder="distilled water, PBS, saline, air"}}
      </div>

    </div>


    <!-- Third row. Experimental design. -->
    <div class="form-group row">

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Age at start of exposure">
              Age at start*</label>
        <input class="form-control" type="text"
               name='ageAtStart'
               value="{{ageAtStart}}"
               placeholder="6-8 wk old, 2 mo old, newborn"/>
      </div>

      <div class="col-xs-3">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Exposure duration including additional observation time (if any)">
              Duration*</label>
        <input class="form-control" type="text"
               name='duration'
               value="{{duration}}"
               placeholder="110 wk, 24 mo, lifetime"/>
      </div>

      <div class="col-xs-6">
        <label class="helpPopovers" data-toggle="popover"
              data-content="Dosing regimen of the agent tested, and (if any)
              information on any co-exposure or modifying factors (e.g., NDEA,
              TPA, Aflatoxin B1, UV) including route, concentration and
              dosing regimen">
              Dosing regimen*</label>
        <input class="form-control" type="text"
               name='dosingRegimen'
               value="{{dosingRegimen}}"
               placeholder="2x/d for 103 wk; 2x/wk for 20 mo"/>
      </div>

    </div>


    <!-- Fourth row. Comments. -->
    <div class="form-group row">

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
               data-content="e.g., GLP study, multiple doses tested,
               high number of animals per group">
              Principal strengths</label>
        {{> typeaheadSelectList name="strengths" values=strengths methodName="searchAnimalStrengths"}}
      </div>

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover"
               data-content="e.g., inadequate duration, no controls,
               small number of animals per group,
               inadequate reporting of exposure or results,
               high mortality, MTD not reached">
              Principal limitations</label>
        {{> typeaheadSelectList name="limitations" values=limitations methodName="searchAnimalLimitations"}}
      </div>

      <div class="col-xs-4">
        <label class="helpPopovers" data-toggle="popover" data-content="As reported">
          Other comments</label>
        <textarea class="form-control" type="text"
                  rows="3" name="comments">{{comments}}</textarea>
      </div>

    </div>


    <div id="errors"></div>

    <!-- QA notice -->
    {{#if isQA }}
      <strong>{{QAstampFormat timestampQA user_id_QA}}</strong>
    {{/if}}

    <!-- Submission -->
    <div class="well well-sm pager">
      {{#if isNew }}
        <button type="button"
                class="btn btn-sm btn-primary"
                id="create"
                title="Save new">
                <span class="glyphicon glyphicon-ok"></span> Create</button>
        <button type="button"
                class="btn btn-sm btn-default"
                id="create-cancel"
                title="Cancel">Cancel</button>
      {{else}}
        {{#if isQA }}
          <button type="button"
                  class="btn btn-sm btn-default"
                  id="update-cancel"
                  title="Cancel changes">Close</button>
          {{#if isInRole 'staff'}}
            <button type ="button"
                      id   ="unsetQA"
                      class="pull-right btn btn-sm btn-warning"
                      title="Unset data as QA'd and allow further changes">
                      <span class="fa fa-exclamation-circle"></span> Remove QA'd</button>
          {{/if}}
        {{else}}
          <button type="button"
                  class="btn btn-sm btn-primary"
                  id="update"
                  title="Save changes">
                  <span class="glyphicon glyphicon-ok"></span> Save</button>
          <button type="button"
                  class="btn btn-sm btn-default"
                  id="update-cancel"
                  title="Cancel changes">Cancel</button>
          <button type="button"
                  class="btn btn-sm btn-danger"
                  id="delete" title="Delete row">
                  <span class="glyphicon glyphicon-trash"></span></button>
          {{#if isInRole 'staff'}}
            <button type ="button"
                    id   ="setQA"
                    class="pull-right btn btn-sm btn-success"
                    title="Make data as QA'd and prevent further changes">
                    <span class="fa fa-check-circle"></span> Mark QA'd</button>
          {{/if}}
        {{/if}}
      {{/if}}
    </div>
  </form>
  <!-- Add input form-modals outside form scope -->
  {{> referenceQuickAddModal}}
</template>


<template name="animalEndpointTbl">
  {{#if showRow isHidden}}
    <div class="menu-autohide {{#if isHidden}}hiddenRow{{/if}}"
        data-id="{{_id}}"
        data-sortIdx="{{sortIdx}}">
      <table class="table table-condensed nestedTbl">
        <colgroup>
          <col width="100%">
        </colgroup>
        <tbody>
          <tr>
            <td>
              {{#if userCanEdit}}
                <div id="nestedModalHolder"></div>
                <div class="rowOptions btn-group pull-right">
                  <button class="btn btn-default btn-xs dropdown-toggle"
                          type="button" data-toggle="dropdown">
                          <span class="caret" title="Editing options"></span></button>
                  <ul class="dropdown-menu">
                    <li>
                      <a href="#" id="inner-show-edit">
                        <span class="glyphicon glyphicon-edit"></span> Edit</a></li>
                    <li>
                      <a href="#" id="clone-nested-content">
                        <span class="fa fa-copy"></span> Create a clone</a></li>
                    <li>
                      <a href="#" id="inner-toggle-hidden">{{#if isHidden}}
                        <span class="glyphicon glyphicon-plus"></span> Show row
                        {{else}}<span class="glyphicon glyphicon-minus"></span> Hide row
                        {{/if}}</a></li>
                  </ul>
                </div>
              {{/if}}
              {{qaMark isQA}}
              <strong>{{tumourSite}}: {{histology}}</strong><br>
              <table class="aniEvidenceTbl">
                <colgroup>
                  <col width="70%">
                  <col width="30%">
                </colgroup>
                <tbody>
                  {{{getIncidents}}}
                  {{{getMultiplicities}}}
                  {{{getTotalTumours}}}
                </tbody>
              </table>
            </td>
            <td class="dragHandle dhInner"
                style="display: none"
                title="Drag to re-order rows"></td>
          </tr>
        </tbody>
      </table>
    </div>
  {{/if}}
</template>


<template name="animalEndpointForm">
  <div class="modal fade" id="nestedModalDiv" tabindex="-1" role="dialog"
       data-backdrop="static" aria-labelledby="nestedModalDiv" aria-hidden="true">
    {{#with getObject }}   <!-- Reactive nested-value  -->
    <div class="modal-dialog modal-lg">
      <div class="modal-content">

        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          <h4 class="modal-title">Animal endpoint evidence</h4>
        </div>

        <div class="modal-body">
          <form id="nestedModalForm" role="form" class="editForm">
            <p class="help-block">Hover-over field labels for more descriptive text. Fields marked with an asterisk (<b>*</b>) are required.{{>formLegendPulldown}}</p>

            <!-- First row -->
            <div class="form-group row">

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="e.g., Skin, Lung, Bronchiolo alveolar,
                       Thymus, Lymphoid tissue, Soft tissue, Harderian gland,
                       Pleural tissue">
                  Tumour site*</label>
                {{> typeaheadInput name="tumourSite" value=tumourSite methodName="searchAnimalTumourSite" placeholder="Skin, lung, bronchio alveolar"}}
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="e.g., squamous cell carcinoma, papilloma,
                                     adenoma, lymphoma, fibrosarcoma,
                                     mesothelioma, haemangiosarcoma">
                  Histology*</label>
                {{> typeaheadInput name="histology" value=histology methodName="searchAnimalHistology" placeholder="squamous cell carcinoma, adenoma"}}
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="e.g., mg/mL, mg/kg, mg/kg bw, µg/m³">
                  Dosing units*</label>
                {{> typeaheadInput name="units" value=units methodName="searchAnimalUnits" placeholder="mg/kg bw"}}
              </div>

            </div>

            <!--  Second row. Endpoint-group -->
            <table class="table table-condensed">
              <colgroup>
                <col width="8%">
                <col width="15%">
                <col width="15%">
                <col width="15%">
                <col width="15%">
                <col width="15%">
                <col width="15%">
              </colgroup>
              <thead>
                <tr>
                  <th style="vertical-align: middle;" class="text-center">
                      <button type="button" class="btn btn-xs btn-info"
                              id="inner-addEndpointGroup" title="Add row">
                              <span class="glyphicon glyphicon-plus"></span></button></th>
                  <th class="text-center">
                    <span class="helpPopovers" data-toggle="popover"
                          data-content="As reported">
                          <br>Dose*</span></th>
                  <th class="text-center">
                    <span class="helpPopovers" data-toggle="popover"
                          data-content="As reported">
                          N<br>at start*</span></th>
                  <th class="text-center">
                    <span class="helpPopovers" data-toggle="popover"
                          data-content="As reported (if available)">
                          N<br>surviving</span></th>
                  <th class="text-center">
                    <span class="helpPopovers" data-toggle="popover"
                          data-content="N of tumour-bearing animals/N of animals
                          at risk [use N at start if N at risk is unknown]. Add
                          asterisk(s) to identify a significant incidence
                          (e.g.: 4/11*, 6/37, 6/50**)">
                          Tumour<br>incidence</span></th>
                  <th class="text-center">
                    <span class="helpPopovers" data-toggle="popover"
                          data-content="Mean number of tumours/tumour-bearing animal.
                          Add asterisk(s) to identify a significant multiplicity
                          (e.g.: 1.0, 1.23, 3.87*)">
                          Tumour<br>multiplicity</span></th>
                  <th class="text-center">
                    <span class="helpPopovers" data-toggle="popover"
                          data-content="Total number of tumours per group.
                          Add asterisk(s) to identify a significant number
                          (e.g.: 0, 13*, 225**)">
                          Total<br>Tumours</span></th>
                </tr>
              </thead>
              <tbody class="endpointGroupTbody">
                {{#if endpointGroups}}
                  {{#each endpointGroups}}
                    {{> animalEndpointGroupForm this}}
                  {{/each}}
                {{else}}
                  {{> animalEndpointGroupForm}}
                {{/if}}
              </tbody>
            </table>


            <!-- Final row -->
            <div class="form-group row">

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Indicate p-value, statistical test used,
                       and reference group (in square brackets if Working Group
                       calculation). e.g. *p=0.024, 1-tail Cochran-Armitage,
                       trend; **[p<0.05, 1-tail Fisher exact, vs. pooled controls]">
                  Incidence significance notes</label>
                <textarea class="form-control"
                          name='incidence_significance'
                          rows="3">{{incidence_significance}}</textarea>
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Indicate p-value, statistical test used,
                       and reference group (in square brackets if Working Group
                       calculation). e.g. *p<0.05, Student t-test, vs controls;
                       **[p<0.01, Wilcoxon test, vs. untreated controls]">
                  Multiplicity significance notes</label>
                <textarea class="form-control"
                          name='multiplicity_significance'
                          rows="3">{{multiplicity_significance}}</textarea>
              </div>

              <div class="col-xs-4">
                <label class="helpPopovers" data-toggle="popover"
                       data-content="Indicate significance level, statistical
                        test used, and reference group.">
                  Total tumours significance notes</label>
                <textarea class="form-control"
                          name='total_tumours_significance'
                          rows="3">{{total_tumours_significance}}</textarea>
              </div>

            </div>

            <div id="errors"></div>

            <!-- QA notice -->
            {{#if isQA }}
              <strong>{{QAstampFormat timestampQA user_id_QA}}</strong>
            {{/if}}

            <!-- Submission -->
            <div class="well well-sm pager">

              <!--
              <button type="button"
                  class="btn btn-sm btn-default"
                  id="calculate-statistics"
                  title="Get basic statistics">Get statistics</button>
              -->

              {{#if isNew }}
                <button type="button" class="btn btn-sm btn-primary"
                        id="inner-create" title="Save new">
                        <span class="glyphicon glyphicon-ok"></span> Create</button>
                <button type="button" class="btn btn-sm btn-default"
                        id="inner-create-cancel" title="Cancel">Cancel</button>
              {{else}}
                {{#if isQA }}
                  <button type="button"
                          class="btn btn-sm btn-default"
                          id="inner-update-cancel"
                          title="Cancel changes">Close</button>
                  {{#if isInRole 'staff'}}
                    <button type="button"
                              id="unsetQA"
                           class="pull-right btn btn-sm btn-warning"
                           title="Unset data as QA'd and allow further changes">
                        <span class="fa fa-exclamation-circle"></span> Remove QA'd</button>
                  {{/if}}
                {{else}}
                  <button type="button" class="btn btn-sm btn-primary"
                          id="inner-update" title="Save changes">
                          <span class="glyphicon glyphicon-ok"></span> Save</button>
                  <button type="button" class="btn btn-sm btn-default"
                          id="inner-update-cancel" title="Cancel changes">Cancel</button>
                  <button type="button" class="btn btn-sm btn-danger"
                          id="inner-delete" title="Delete row">
                          <span class="glyphicon glyphicon-trash"></span></button>
                  {{#if isInRole 'staff'}}
                    <button type="button"
                              id="setQA"
                           class="pull-right btn btn-sm btn-success"
                           title="Make data as QA'd and prevent further changes">
                        <span class="fa fa-check-circle"></span> Mark QA'd</button>
                  {{/if}}
                {{/if}}
              {{/if}}
            </div>

          </form>
        </div>  <!-- Modal body -->
      </div>  <!-- Modal content -->
    </div>  <!-- Modal dialog -->
    {{/with}}  <!-- Reactive epiResult  -->
  </div>  <!-- Modal container -->
</template>


<template name="animalEndpointGroupForm">
  <tr>
    <td class="text-center" style="vertical-align: middle;">
      <button type="button" class="btn btn-xs btn-danger"
                id="endpointGroup-delete" title="Delete row">
                <span class="glyphicon glyphicon-trash"></span></button>
    </td>
    <td>
      <input class="form-control" type="text"
             tabindex='1'
             name='dose'
             value="{{dose}}"/>
    </td>
    <td>
      <input class="form-control" type="number"
             tabindex='2'
             name='nStart'
             value="{{nStart}}"/>
    </td>
    <td>
      <input class="form-control" type="text"
             tabindex='3'
             name='nSurviving'
             value="{{nSurviving}}"/>
    </td>
    <td>
      <input class="form-control" type="text"
             tabindex='4'
             name='incidence'
             value="{{incidence}}"/>
    </td>
    <td>
      <input class="form-control" type="text"
             tabindex='5'
             name='multiplicity'
             value="{{multiplicity}}"/>
    </td>
    <td>
      <input class="form-control" type="text"
             tabindex='6'
             name='totalTumours'
             value="{{totalTumours}}"/>
    </td>
  </tr>
</template>
