<template name="my_lists">
  <div class="container">
  {{#if currentUser}}
      {{> myTbl }}
    {{else }}
      <h1>Welcome to the IARC table builder</h1>
      <p>This application is designed to store and display key data used in the IARC monograph assessments. Groups of users can collaboratively work together to build evidence tables from multiple streams of evidence.</p>
      <p>Access is controlled; you'll need to login in order to view or edit documents.</p>
    {{/if}}
  </div>
</template>

<template name="myTbl">
  <h1>Tables which I've created.
    <div class="btn-group pull-right">
      <button class="btn btn-default btn-xs dropdown-toggle" type="button" data-toggle="dropdown">
        <span class="caret" title="Editing options"></span>
      </button>
      <ul class="dropdown-menu">
        {{#unless showNew}}
          <li><a href="#" id="myTbl-show-create"><span class="glyphicon glyphicon-plus"></span> New</a></li>
        {{/unless}}
      </ul>
    </div>
  </h1>

  <table class="table table-compressed table-striped">
    <thead>
      <tr>
        <th>Monograph &amp; Agent</th>
        <th>Table Name</th>
        <th>Table Type</th>
        <th>Created</th>
        <th>Table<br>Configuration</th>
      </tr>
    </thead>
    <tbody>
      {{#each getMyTbls}}
        <tr>
          {{#if isEditing}}
            <td id="editingRow" colspan="100">
              {{> myTblForm}}
            </td>
          {{else}}
            <td>{{monographNumber}}: {{agent}}</td>
            <td><a href="{{getURL}}">{{name}}</a></td>
            <td>{{tblType}}</td>
            <td>{{formatDate timestamp "long"}}</td>
            {{#if canEdit }}
              <td><a class="btn btn-default" href="#" id="myTbl-show-edit"><span class="glyphicon glyphicon-edit"></span> Edit</a></td>
            {{else}}
              <td>-</td>
            {{/if}}
          {{/if}}
        </tr>
      {{else}}
        {{#unless showNew}}
          <tr>
            <td colspan="100">You haven't created any tables yet.<br><br>
              <a href="#" class="btn btn-primary btn-sm" id="myTbl-show-create"><span class="glyphicon glyphicon-plus"></span> Create new</a>
            </td>
          </tr>
        {{/unless}}
      {{/each}}
    </tbody>
  </table>

  {{#if showNew}}
    {{> myTblForm}}
  {{/if}}
</template>

<template name="myTblForm">
  <form id="myTblForm" role="form" class="editForm">
    <div class="form-group row">
      <div class="col-xs-2">
        <label>Monograph Number</label>
        <input class="form-control" name='monographNumber' type="number" value="{{monographNumber}}"/>
      </div>
      <div class="col-xs-5">
        <label>Agent Name</label>
        <input class="form-control" name='agent' type="text" value="{{agent}}"/>
      </div>
      <div class="col-xs-5">
        <label>Table Type</label>
        <select class="form-control" name='tblType' type="text">
          <option selected={{TblTypeSelected prev=tblType opt="Epidemiology - Cohort"}} >Epidemiology - Cohort</option>
          <option selected={{TblTypeSelected prev=tblType opt="Epidemiology - Case Control"}} >Epidemiology - Case Control</option>
        </select>
      </div>
    </div>
    <div class="form-group">
      <label>Table Name</label>
      <input class="form-control" name='name' type="text" value="{{name}}"/>
    </div>
    <div class="form-group row">
      <div class="col-xs-4">
        <label>Project managers</label>
        <input class="form-control typeahead" name='projectManagers' type="text" autocomplete="off" data-source="searchUsers" data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can change permissions for who has access.</p>
        <ul class="projectManagers">
          {{#each getRoledUsers 'projectManagers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
      <div class="col-xs-4">
        <label>Team members</label>
        <input class="form-control typeahead" name='teamMembers' type="text" autocomplete="off" data-source="searchUsers" data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can create/change/delete content for a selected table.</p>
        <ul class="teamMembers">
          {{#each getRoledUsers 'teamMembers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
      <div class="col-xs-4">
        <label>Reviewers</label>
        <input class="form-control typeahead" name='reviewers' type="text" autocomplete="off" data-source="searchUsers" data-template="UserMatchPullDown" placeholder="Type to search by email"/>
        <p class="help-block">Can view but not change content.</p>
        <ul class="reviewers">
          {{#each getRoledUsers 'reviewers'}}
            {{> UserLI}}
          {{/each}}
        </ul>
      </div>
    </div>
    <div class="well well-sm pager">
      {{#if _id}}
        <button type="button" class="btn btn-sm btn-primary" id="myTbl-update" title="Save changes"><span class="glyphicon glyphicon-ok"></span> Save</button>
        <button type="button" class="btn btn-sm btn-default" id="myTbl-update-cancel" title="Cancel changes">Cancel</button>
        <button type="button" class="btn btn-sm btn-danger"  id="myTbl-delete" title="Delete row"><span class="glyphicon glyphicon-trash"></span></button>
      {{else}}
        <button type="button" class="btn btn-sm btn-primary" id="myTbl-create" title="Save new"><span class="glyphicon glyphicon-ok"> Create</span></button>
        <button type="button" class="btn btn-sm btn-default" id="myTbl-create-cancel" title="Cancel">Cancel</button>
      {{/if}}
    </div>
  </form>
</template>


<template name="UserMatchPullDown">
  <p><b>Email:</b> {{email}}</p>
</template>

<template name="UserLI">
  <li class='userListItem' data-user_id='{{_id}}'>{{getEmail}}
    <a href='#' class='pull-right removeUser btn btn-default btn-xs' title='Remove from list'>
      <span class='glyphicon glyphicon-remove'></span>
    </a>
  </li>
</template>
